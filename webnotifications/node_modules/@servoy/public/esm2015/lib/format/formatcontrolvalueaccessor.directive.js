import { Directive, Input, HostListener, forwardRef, Inject } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { MaskFormat } from './maskformat';
import { DOCUMENT } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "./formatting.service";
import * as i2 from "../logger.service";
class NumberParser {
    constructor() {
        const locale = new Intl.NumberFormat().resolvedOptions().locale;
        const parts = new Intl.NumberFormat(locale).formatToParts(12345.6);
        const numerals = [...new Intl.NumberFormat(locale, { useGrouping: false }).format(9876543210)].reverse();
        const index = new Map(numerals.map((d, i) => [d, i]));
        this._group = new RegExp(`[${parts.find(d => d.type === 'group').value}]`, 'g');
        this._decimal = new RegExp(`[${parts.find(d => d.type === 'decimal').value}]`);
        this._numeral = new RegExp(`[${numerals.join('')}]`, 'g');
        this._index = d => index.get(d).toString();
    }
    parse(str) {
        return (str.trim().replace(this._group, '').replace(this._decimal, '.').replace(this._numeral, this._index)) ? +str : NaN;
    }
}
export class FormatDirective {
    constructor(_renderer, _elementRef, formatService, doc, logFactory) {
        this._renderer = _renderer;
        this._elementRef = _elementRef;
        this.formatService = formatService;
        this.doc = doc;
        this.hasFocus = false;
        this.realValue = null;
        this.isKeyPressEventFired = false;
        this.oldInputValue = null;
        this.listeners = [];
        this.onChangeCallback = (_) => { };
        this.onTouchedCallback = () => { };
        this.log = logFactory.getLogger('formatdirective');
    }
    touched() {
        this.onTouchedCallback();
        this.hasFocus = false;
        if (this.format.display && this.format.edit && this.format.edit !== this.format.display) {
            this.writeValue(this.realValue);
        }
    }
    focussed() {
        this.hasFocus = true;
        if (this.format.display && this.format.edit && this.format.edit !== this.format.display) {
            this.writeValue(this.realValue);
        }
    }
    input(value) {
        let data = value;
        const inputType = this.getType();
        if (inputType === 'datetime-local') {
            data = this.formatService.unformat(value, FormatDirective.DATETIMEFORMAT.display, FormatDirective.DATETIMEFORMAT.type, this.realValue);
        }
        else if (inputType === 'date') {
            data = this.formatService.unformat(value, FormatDirective.DATEFORMAT.display, FormatDirective.DATEFORMAT.type, this.realValue);
        }
        else if (inputType === 'time') {
            data = this.formatService.unformat(value, FormatDirective.TIMEFORMAT.display, FormatDirective.TIMEFORMAT.type, this.realValue);
        }
        else if (inputType === 'month') {
            data = this.formatService.unformat(value, FormatDirective.MONTHFORMAT.display, FormatDirective.MONTHFORMAT.type, this.realValue);
        }
        else if (inputType === 'week') {
            data = this.formatService.unformat(value, FormatDirective.WEEKFORMAT.display, FormatDirective.WEEKFORMAT.type, this.realValue);
        }
        else if (inputType === 'number') {
            data = FormatDirective.BROWSERNUMBERFORMAT.parse(value);
        }
        else if (inputType === 'email') {
            data = value;
        }
        else if (!this.findmode && this.format) {
            const type = this.format.type;
            let format = this.format.display ? this.format.display : this.format.edit;
            if (this.hasFocus && this.format.edit && !this.format.isMask)
                format = this.format.edit;
            try {
                data = this.formatService.unformat(data, format, type, this.realValue);
            }
            catch (e) {
                this.log.error(e);
                //TODO set error state
            }
            if (this.format.type === 'TEXT' && this.format.isRaw && this.format.isMask) {
                if (data && format && data.length === format.length) {
                    let ret = '';
                    for (let i = 0; i < format.length; i++) {
                        switch (format[i]) {
                            case 'U':
                            case 'L':
                            case 'A':
                            case '?':
                            case '*':
                            case 'H':
                            case '#':
                                ret += data[i];
                                break;
                            default:
                                // ignore literal characters
                                break;
                        }
                    }
                    data = ret;
                }
            }
        }
        this.realValue = data;
        this.onChangeCallback(data);
    }
    ngAfterViewInit() {
        this.setFormat();
    }
    ngOnChanges() {
        this.setFormat();
    }
    registerOnChange(fn) {
        this.onChangeCallback = fn;
    }
    registerOnTouched(fn) {
        this.onTouchedCallback = fn;
    }
    writeValue(value) {
        this.realValue = value;
        const inputType = this.getType();
        if (inputType === 'datetime-local') {
            const data = this.formatService.format(value, FormatDirective.DATETIMEFORMAT, false);
            this._renderer.setProperty(this._elementRef.nativeElement, 'value', data);
        }
        else if (inputType === 'date') {
            const data = this.formatService.format(value, FormatDirective.DATEFORMAT, false);
            this._renderer.setProperty(this._elementRef.nativeElement, 'value', data);
        }
        else if (inputType === 'time') {
            const data = this.formatService.format(value, FormatDirective.TIMEFORMAT, false);
            this._renderer.setProperty(this._elementRef.nativeElement, 'value', data);
        }
        else if (inputType === 'month') {
            const data = this.formatService.format(value, FormatDirective.MONTHFORMAT, false);
            this._renderer.setProperty(this._elementRef.nativeElement, 'value', data);
        }
        else if (inputType === 'week') {
            const data = this.formatService.format(value, FormatDirective.WEEKFORMAT, false);
            this._renderer.setProperty(this._elementRef.nativeElement, 'value', data);
        }
        else if (inputType === 'number') {
            const data = value ? new Intl.NumberFormat().format(value) : '';
            this._renderer.setProperty(this._elementRef.nativeElement, 'value', data);
        }
        else if (inputType === 'email') {
            this._renderer.setProperty(this._elementRef.nativeElement, 'value', value);
        }
        else if (value && this.format) {
            let data = value;
            if (!this.findmode) {
                data = inputType === 'number' && data.toString().length >= this.format.maxLength ? data.toString().substring(0, this.format.maxLength) : data;
                let useEdit = !this.format.display;
                if (this.format.edit && !this.format.isMask && this.hasFocus)
                    useEdit = true;
                try {
                    data = this.formatService.format(data, this.format, useEdit);
                }
                catch (e) {
                    this.log.error(e);
                }
                if (data && this.format.type === 'TEXT') {
                    if (this.format.uppercase)
                        data = data.toUpperCase();
                    else if (this.format.lowercase)
                        data = data.toLowerCase();
                }
            }
            this._renderer.setProperty(this._elementRef.nativeElement, 'value', data);
        }
        else {
            this._renderer.setProperty(this._elementRef.nativeElement, 'value', value ? value : '');
        }
    }
    getType() {
        const type = this._elementRef.nativeElement.type;
        return type ? type.toLocaleLowerCase() : 'text';
    }
    setFormat() {
        this.listeners.forEach(lFn => lFn());
        this.listeners = [];
        if (this.format) {
            if (!this.findmode && (this.format.uppercase || this.format.lowercase)) {
                this.listeners.push(this._renderer.listen(this._elementRef.nativeElement, 'input', () => this.upperOrLowerCase()));
            }
            if (this.format.isNumberValidator || this.format.type === 'NUMBER' || this.format.type === 'INTEGER') {
                this.listeners.push(this._renderer.listen(this._elementRef.nativeElement, 'keypress', (event) => {
                    this.isKeyPressEventFired = true;
                    return this.formatService.testForNumbersOnly(event, null, this._elementRef.nativeElement, this.findmode, true, this.format, false);
                }));
                this.listeners.push(this._renderer.listen(this._elementRef.nativeElement, 'input', (event) => this.inputFiredForNumbersCheck(event)));
            }
            if (this.format.maxLength) {
                if (!this.findmode) {
                    this._renderer.setAttribute(this._elementRef.nativeElement, 'maxlength', this.format.maxLength + '');
                }
                else {
                    this._renderer.removeAttribute(this._elementRef.nativeElement, 'maxlength');
                }
            }
            if (!this.findmode && this.format.isMask) {
                new MaskFormat(this.format, this._renderer, this._elementRef.nativeElement, this.formatService, this.doc);
            }
            this.writeValue(this.realValue);
        }
    }
    // lower and upper case handling
    upperOrLowerCase() {
        const element = this._elementRef.nativeElement;
        const caretPos = element.selectionStart;
        element.value = this.format.uppercase ? element.value.toUpperCase() : element.value.toLowerCase();
        element.setSelectionRange(caretPos, caretPos);
    }
    inputFiredForNumbersCheck(event) {
        let currentValue = this._elementRef.nativeElement.value;
        if (!this.isKeyPressEventFired && event.target.tagName.toUpperCase() === 'INPUT') {
            // get inserted chars
            const inserted = this.findDelta(currentValue, this.oldInputValue);
            // get removed chars
            const removed = this.findDelta(this.oldInputValue, currentValue);
            // determine if user pasted content
            const pasted = inserted.length > 1 || (!inserted && !removed);
            if (!pasted && !removed) {
                if (!this.formatService.testForNumbersOnly(event, inserted, this._elementRef.nativeElement, this.findmode, true, this.format, true)) {
                    currentValue = this.oldInputValue;
                }
            }
            //If number validator, check all chars in string and extract only the valid chars.
            if (event.target.type.toUpperCase() === 'NUMBER' || this.format.type === 'NUMBER' || this.format.type === 'INTEGER' || this.format.isNumberValidator) {
                currentValue = this.getNumbersFromString(event, currentValue, this.oldInputValue);
            }
            if (currentValue !== this._elementRef.nativeElement.value) {
                this._elementRef.nativeElement.value = currentValue;
                // // detect IE8 and above, and Edge; call on change manually because of https://bugs.jquery.com/ticket/10818
                // if (/MSIE/.test(navigator.userAgent) || /rv:11.0/i.test(navigator.userAgent) || /Edge/.test(navigator.userAgent)) {
                // 	var changeOnBlurForIE = function() {
                // 		 element.change();
                // 		 element.off("blur", callChangeOnBlur);
                // 	 }
                // 	 element.on("blur", changeOnBlurForIE);
                // }
            }
            this.oldInputValue = currentValue;
            this.isKeyPressEventFired = false;
        }
        if (this.isKeyPressEventFired) {
            this.oldInputValue = currentValue;
            this.isKeyPressEventFired = false;
        }
    }
    findDelta(value, prevValue) {
        let delta = '';
        if (typeof value === 'string' && typeof prevValue === 'string' && value.length >= prevValue.length) {
            for (let i = 0; i < value.length; i++) {
                const str = value.substr(0, i) + value.substr(i + value.length - prevValue.length);
                if (str === prevValue) {
                    delta = value.substr(i, value.length - prevValue.length);
                    break;
                }
            }
        }
        return delta;
    }
    getNumbersFromString(e, currentValue, oldInputValue) {
        if (oldInputValue === currentValue) {
            return currentValue;
        }
        let stripped = '';
        for (let i = 0; i < currentValue.length; i++) {
            if (this.formatService.testForNumbersOnly(e, currentValue.charAt(i), this._elementRef.nativeElement, this.findmode, true, this.format, true)) {
                stripped = stripped + currentValue.charAt(i);
                if (stripped.length === this.format.maxLength)
                    break;
            }
        }
        return stripped;
    }
}
FormatDirective.DATETIMEFORMAT = { display: 'yyyy-MM-ddTHH:mm:ss', type: 'DATETIME' };
FormatDirective.DATEFORMAT = { display: 'yyyy-MM-dd', type: 'DATETIME' };
FormatDirective.MONTHFORMAT = { display: 'yyyy-MM', type: 'DATETIME' };
FormatDirective.WEEKFORMAT = { display: 'YYYY-[W]WW', type: 'DATETIME' };
FormatDirective.TIMEFORMAT = { display: 'HH:mm', type: 'DATETIME' };
FormatDirective.BROWSERNUMBERFORMAT = new NumberParser();
FormatDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: FormatDirective, deps: [{ token: i0.Renderer2 }, { token: i0.ElementRef }, { token: i1.FormattingService }, { token: DOCUMENT }, { token: i2.LoggerFactory }], target: i0.ɵɵFactoryTarget.Directive });
FormatDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.0.2", type: FormatDirective, selector: "[svyFormat]", inputs: { format: ["svyFormat", "format"], findmode: "findmode" }, host: { listeners: { "blur": "touched()", "focus": "focussed()", "change": "input($event.target.value)" } }, providers: [{
            provide: NG_VALUE_ACCESSOR,
            useExisting: forwardRef(() => FormatDirective),
            multi: true
        }], usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: FormatDirective, decorators: [{
            type: Directive,
            args: [{
                    // eslint-disable-next-line @angular-eslint/directive-selector
                    selector: '[svyFormat]',
                    providers: [{
                            provide: NG_VALUE_ACCESSOR,
                            useExisting: forwardRef(() => FormatDirective),
                            multi: true
                        }]
                }]
        }], ctorParameters: function () { return [{ type: i0.Renderer2 }, { type: i0.ElementRef }, { type: i1.FormattingService }, { type: Document, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }, { type: i2.LoggerFactory }]; }, propDecorators: { format: [{
                type: Input,
                args: ['svyFormat']
            }], findmode: [{
                type: Input
            }], touched: [{
                type: HostListener,
                args: ['blur', []]
            }], focussed: [{
                type: HostListener,
                args: ['focus', []]
            }], input: [{
                type: HostListener,
                args: ['change', ['$event.target.value']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0Y29udHJvbHZhbHVlYWNjZXNzb3IuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvc2Vydm95LXB1YmxpYy9zcmMvbGliL2Zvcm1hdC9mb3JtYXRjb250cm9sdmFsdWVhY2Nlc3Nvci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFNBQVMsRUFBeUIsS0FBSyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQTRCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwSSxPQUFPLEVBQXdCLGlCQUFpQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUUxQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7Ozs7QUFJM0MsTUFBTSxZQUFZO0lBS2hCO1FBQ0UsTUFBTSxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsZUFBZSxFQUFFLENBQUMsTUFBTSxDQUFDO1FBQ2hFLE1BQU0sS0FBSyxHQUFJLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQVMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUUsTUFBTSxRQUFRLEdBQUcsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsRUFBQyxXQUFXLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN2RyxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FB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QUUsSUFBSTt5QkFDZCxDQUFDO2lCQUNMOzJJQXFCc0MsUUFBUTswQkFBdEMsTUFBTTsyQkFBQyxRQUFRO3dFQVpBLE1BQU07c0JBQXpCLEtBQUs7dUJBQUMsV0FBVztnQkFDVCxRQUFRO3NCQUFoQixLQUFLO2dCQWVvQixPQUFPO3NCQUFoQyxZQUFZO3VCQUFDLE1BQU0sRUFBRSxFQUFFO2dCQVFHLFFBQVE7c0JBQWxDLFlBQVk7dUJBQUMsT0FBTyxFQUFFLEVBQUU7Z0JBT3dCLEtBQUs7c0JBQXJELFlBQVk7dUJBQUMsUUFBUSxFQUFFLENBQUMscUJBQXFCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IHsgRGlyZWN0aXZlLCBSZW5kZXJlcjIsIEVsZW1lbnRSZWYsIElucHV0LCBIb3N0TGlzdGVuZXIsIGZvcndhcmRSZWYsIEFmdGVyVmlld0luaXQsIE9uQ2hhbmdlcywgSW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBOR19WQUxVRV9BQ0NFU1NPUiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgTWFza0Zvcm1hdCB9IGZyb20gJy4vbWFza2Zvcm1hdCc7XHJcbmltcG9ydCB7IEZvcm1hdCwgRm9ybWF0dGluZ1NlcnZpY2UgfSBmcm9tICcuL2Zvcm1hdHRpbmcuc2VydmljZSc7XHJcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuaW1wb3J0IHsgTG9nZ2VyRmFjdG9yeSwgTG9nZ2VyU2VydmljZSB9IGZyb20gJy4uL2xvZ2dlci5zZXJ2aWNlJztcclxuXHJcblxyXG5jbGFzcyBOdW1iZXJQYXJzZXIge1xyXG4gIHByaXZhdGUgX2dyb3VwOiBSZWdFeHA7XHJcbiAgICBwcml2YXRlIF9kZWNpbWFsOiBSZWdFeHA7XHJcbiAgICBwcml2YXRlIF9udW1lcmFsOiBSZWdFeHA7XHJcbiAgICBwcml2YXRlIF9pbmRleDogKGQ6IGFueSkgPT4gc3RyaW5nO1xyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgY29uc3QgbG9jYWxlID0gbmV3IEludGwuTnVtYmVyRm9ybWF0KCkucmVzb2x2ZWRPcHRpb25zKCkubG9jYWxlO1xyXG4gICAgY29uc3QgcGFydHMgPSAobmV3IEludGwuTnVtYmVyRm9ybWF0KGxvY2FsZSkgYXMgYW55KS5mb3JtYXRUb1BhcnRzKDEyMzQ1LjYpO1xyXG4gICAgY29uc3QgbnVtZXJhbHMgPSBbLi4ubmV3IEludGwuTnVtYmVyRm9ybWF0KGxvY2FsZSwge3VzZUdyb3VwaW5nOiBmYWxzZX0pLmZvcm1hdCg5ODc2NTQzMjEwKV0ucmV2ZXJzZSgpO1xyXG4gICAgY29uc3QgaW5kZXggPSBuZXcgTWFwKG51bWVyYWxzLm1hcCgoZCwgaSkgPT4gW2QsIGldKSk7XHJcbiAgICB0aGlzLl9ncm91cCA9IG5ldyBSZWdFeHAoYFske3BhcnRzLmZpbmQoZCA9PiBkLnR5cGUgPT09ICdncm91cCcpLnZhbHVlfV1gLCAnZycpO1xyXG4gICAgdGhpcy5fZGVjaW1hbCA9IG5ldyBSZWdFeHAoYFske3BhcnRzLmZpbmQoZCA9PiBkLnR5cGUgPT09ICdkZWNpbWFsJykudmFsdWV9XWApO1xyXG4gICAgdGhpcy5fbnVtZXJhbCA9IG5ldyBSZWdFeHAoYFske251bWVyYWxzLmpvaW4oJycpfV1gLCAnZycpO1xyXG4gICAgdGhpcy5faW5kZXggPSBkID0+IGluZGV4LmdldChkKS50b1N0cmluZygpO1xyXG4gIH1cclxuICBwYXJzZShzdHI6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIChzdHIudHJpbSgpLnJlcGxhY2UodGhpcy5fZ3JvdXAsICcnKS5yZXBsYWNlKHRoaXMuX2RlY2ltYWwsICcuJykucmVwbGFjZSh0aGlzLl9udW1lcmFsLCB0aGlzLl9pbmRleCkpID8gK3N0ciA6IE5hTjtcclxuICB9XHJcbn1cclxuXHJcbkBEaXJlY3RpdmUoe1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvZGlyZWN0aXZlLXNlbGVjdG9yXHJcbiAgICBzZWxlY3RvcjogJ1tzdnlGb3JtYXRdJyxcclxuICAgIHByb3ZpZGVyczogW3tcclxuICAgICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcclxuICAgICAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBGb3JtYXREaXJlY3RpdmUpLFxyXG4gICAgICAgIG11bHRpOiB0cnVlXHJcbiAgICB9XVxyXG59KVxyXG5leHBvcnQgY2xhc3MgRm9ybWF0RGlyZWN0aXZlIGltcGxlbWVudHMgQ29udHJvbFZhbHVlQWNjZXNzb3IsIEFmdGVyVmlld0luaXQsIE9uQ2hhbmdlcyB7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBEQVRFVElNRUZPUk1BVDogRm9ybWF0ID0ge2Rpc3BsYXk6J3l5eXktTU0tZGRUSEg6bW06c3MnLCB0eXBlOidEQVRFVElNRSd9IGFzIEZvcm1hdDtcclxuICAgIHByaXZhdGUgc3RhdGljIERBVEVGT1JNQVQ6IEZvcm1hdCA9IHtkaXNwbGF5Oid5eXl5LU1NLWRkJywgdHlwZTonREFURVRJTUUnfSBhcyBGb3JtYXQ7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBNT05USEZPUk1BVDogRm9ybWF0ID0ge2Rpc3BsYXk6J3l5eXktTU0nLCB0eXBlOidEQVRFVElNRSd9IGFzIEZvcm1hdDtcclxuICAgIHByaXZhdGUgc3RhdGljIFdFRUtGT1JNQVQ6IEZvcm1hdCA9IHtkaXNwbGF5OidZWVlZLVtXXVdXJywgdHlwZTonREFURVRJTUUnfSBhcyBGb3JtYXQ7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBUSU1FRk9STUFUOiBGb3JtYXQgPSB7ZGlzcGxheTonSEg6bW0nLCB0eXBlOidEQVRFVElNRSd9IGFzIEZvcm1hdDtcclxuICAgIHByaXZhdGUgc3RhdGljIEJST1dTRVJOVU1CRVJGT1JNQVQgPSBuZXcgTnVtYmVyUGFyc2VyKCk7XHJcblxyXG4gICAgQElucHV0KCdzdnlGb3JtYXQnKSBmb3JtYXQ6IEZvcm1hdDtcclxuICAgIEBJbnB1dCgpIGZpbmRtb2RlOiBib29sZWFuO1xyXG5cclxuICAgIHByaXZhdGUgaGFzRm9jdXMgPSBmYWxzZTtcclxuICAgIHByaXZhdGUgcmVhbFZhbHVlID0gbnVsbDtcclxuXHJcbiAgICBwcml2YXRlIGlzS2V5UHJlc3NFdmVudEZpcmVkID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIG9sZElucHV0VmFsdWUgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBsaXN0ZW5lcnMgPSBbXTtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nOiBMb2dnZXJTZXJ2aWNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX3JlbmRlcmVyOiBSZW5kZXJlcjIsIHByaXZhdGUgX2VsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHByaXZhdGUgZm9ybWF0U2VydmljZTogRm9ybWF0dGluZ1NlcnZpY2UsXHJcbiAgICAgICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2M6IERvY3VtZW50LCBsb2dGYWN0b3J5OiBMb2dnZXJGYWN0b3J5KSB7XHJcbiAgICAgICAgdGhpcy5sb2cgPSBsb2dGYWN0b3J5LmdldExvZ2dlcignZm9ybWF0ZGlyZWN0aXZlJyk7XHJcbiAgICB9XHJcblxyXG4gICAgQEhvc3RMaXN0ZW5lcignYmx1cicsIFtdKSB0b3VjaGVkKCkge1xyXG4gICAgICAgIHRoaXMub25Ub3VjaGVkQ2FsbGJhY2soKTtcclxuICAgICAgICB0aGlzLmhhc0ZvY3VzID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKHRoaXMuZm9ybWF0LmRpc3BsYXkgJiYgdGhpcy5mb3JtYXQuZWRpdCAmJiB0aGlzLmZvcm1hdC5lZGl0ICE9PSB0aGlzLmZvcm1hdC5kaXNwbGF5KSB7XHJcbiAgICAgICAgICAgIHRoaXMud3JpdGVWYWx1ZSh0aGlzLnJlYWxWYWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2ZvY3VzJywgW10pIGZvY3Vzc2VkKCkge1xyXG4gICAgICAgIHRoaXMuaGFzRm9jdXMgPSB0cnVlO1xyXG4gICAgICAgIGlmICh0aGlzLmZvcm1hdC5kaXNwbGF5ICYmIHRoaXMuZm9ybWF0LmVkaXQgJiYgdGhpcy5mb3JtYXQuZWRpdCAhPT0gdGhpcy5mb3JtYXQuZGlzcGxheSkge1xyXG4gICAgICAgICAgICB0aGlzLndyaXRlVmFsdWUodGhpcy5yZWFsVmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBASG9zdExpc3RlbmVyKCdjaGFuZ2UnLCBbJyRldmVudC50YXJnZXQudmFsdWUnXSkgaW5wdXQodmFsdWU6IGFueSkge1xyXG4gICAgICAgIGxldCBkYXRhID0gdmFsdWU7XHJcbiAgICAgICAgY29uc3QgaW5wdXRUeXBlID0gdGhpcy5nZXRUeXBlKCk7XHJcbiAgICAgICAgaWYgKGlucHV0VHlwZSA9PT0gJ2RhdGV0aW1lLWxvY2FsJykge1xyXG4gICAgICAgICAgICAgZGF0YSA9IHRoaXMuZm9ybWF0U2VydmljZS51bmZvcm1hdCh2YWx1ZSwgRm9ybWF0RGlyZWN0aXZlLkRBVEVUSU1FRk9STUFULmRpc3BsYXksIEZvcm1hdERpcmVjdGl2ZS5EQVRFVElNRUZPUk1BVC50eXBlLCB0aGlzLnJlYWxWYWx1ZSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChpbnB1dFR5cGUgPT09ICdkYXRlJykge1xyXG4gICAgICAgICAgICAgZGF0YSA9IHRoaXMuZm9ybWF0U2VydmljZS51bmZvcm1hdCh2YWx1ZSwgRm9ybWF0RGlyZWN0aXZlLkRBVEVGT1JNQVQuZGlzcGxheSwgRm9ybWF0RGlyZWN0aXZlLkRBVEVGT1JNQVQudHlwZSwgdGhpcy5yZWFsVmFsdWUpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoaW5wdXRUeXBlID09PSAndGltZScpIHtcclxuICAgICAgICAgICAgIGRhdGEgPSB0aGlzLmZvcm1hdFNlcnZpY2UudW5mb3JtYXQodmFsdWUsIEZvcm1hdERpcmVjdGl2ZS5USU1FRk9STUFULmRpc3BsYXksIEZvcm1hdERpcmVjdGl2ZS5USU1FRk9STUFULnR5cGUsIHRoaXMucmVhbFZhbHVlKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGlucHV0VHlwZSA9PT0gJ21vbnRoJykge1xyXG4gICAgICAgICAgICAgZGF0YSA9IHRoaXMuZm9ybWF0U2VydmljZS51bmZvcm1hdCh2YWx1ZSwgRm9ybWF0RGlyZWN0aXZlLk1PTlRIRk9STUFULmRpc3BsYXksIEZvcm1hdERpcmVjdGl2ZS5NT05USEZPUk1BVC50eXBlLCB0aGlzLnJlYWxWYWx1ZSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChpbnB1dFR5cGUgPT09ICd3ZWVrJykge1xyXG4gICAgICAgICAgICAgZGF0YSA9IHRoaXMuZm9ybWF0U2VydmljZS51bmZvcm1hdCh2YWx1ZSwgRm9ybWF0RGlyZWN0aXZlLldFRUtGT1JNQVQuZGlzcGxheSwgRm9ybWF0RGlyZWN0aXZlLldFRUtGT1JNQVQudHlwZSwgdGhpcy5yZWFsVmFsdWUpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoaW5wdXRUeXBlID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICAgZGF0YSA9IEZvcm1hdERpcmVjdGl2ZS5CUk9XU0VSTlVNQkVSRk9STUFULnBhcnNlKHZhbHVlKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGlucHV0VHlwZSA9PT0gJ2VtYWlsJykge1xyXG4gICAgICAgICAgICAgZGF0YSA9IHZhbHVlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuZmluZG1vZGUgJiYgdGhpcy5mb3JtYXQpIHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IHRoaXMuZm9ybWF0LnR5cGU7XHJcbiAgICAgICAgICAgIGxldCBmb3JtYXQgPSB0aGlzLmZvcm1hdC5kaXNwbGF5ID8gdGhpcy5mb3JtYXQuZGlzcGxheSA6IHRoaXMuZm9ybWF0LmVkaXQ7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmhhc0ZvY3VzICYmIHRoaXMuZm9ybWF0LmVkaXQgJiYgIXRoaXMuZm9ybWF0LmlzTWFzaykgZm9ybWF0ID0gdGhpcy5mb3JtYXQuZWRpdDtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLmZvcm1hdFNlcnZpY2UudW5mb3JtYXQoZGF0YSwgZm9ybWF0LCB0eXBlLCB0aGlzLnJlYWxWYWx1ZSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGUpO1xyXG4gICAgICAgICAgICAgICAgLy9UT0RPIHNldCBlcnJvciBzdGF0ZVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZvcm1hdC50eXBlID09PSAnVEVYVCcgJiYgdGhpcy5mb3JtYXQuaXNSYXcgJiYgdGhpcy5mb3JtYXQuaXNNYXNrKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiBmb3JtYXQgJiYgZGF0YS5sZW5ndGggPT09IGZvcm1hdC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcmV0ID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmb3JtYXQubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChmb3JtYXRbaV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ1UnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnTCc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdBJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJz8nOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnKic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdIJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyMnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldCArPSBkYXRhW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgbGl0ZXJhbCBjaGFyYWN0ZXJzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHJldDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnJlYWxWYWx1ZSA9IGRhdGE7XHJcbiAgICAgICAgdGhpcy5vbkNoYW5nZUNhbGxiYWNrKGRhdGEpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uQ2hhbmdlQ2FsbGJhY2sgPSAoXzogYW55KSA9PiB7IH07XHJcbiAgICBvblRvdWNoZWRDYWxsYmFjayA9ICgpID0+IHsgfTtcclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5zZXRGb3JtYXQoKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uQ2hhbmdlcygpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnNldEZvcm1hdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZ2lzdGVyT25DaGFuZ2UoZm46IGFueSkge1xyXG4gICAgICAgIHRoaXMub25DaGFuZ2VDYWxsYmFjayA9IGZuO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiBhbnkpIHtcclxuICAgICAgICB0aGlzLm9uVG91Y2hlZENhbGxiYWNrID0gZm47XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHdyaXRlVmFsdWUodmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMucmVhbFZhbHVlID0gdmFsdWU7XHJcbiAgICAgICAgY29uc3QgaW5wdXRUeXBlID0gdGhpcy5nZXRUeXBlKCk7XHJcbiAgICAgICAgaWYgKGlucHV0VHlwZSA9PT0gJ2RhdGV0aW1lLWxvY2FsJykge1xyXG4gICAgICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZm9ybWF0U2VydmljZS5mb3JtYXQodmFsdWUsIEZvcm1hdERpcmVjdGl2ZS5EQVRFVElNRUZPUk1BVCwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAndmFsdWUnLCBkYXRhKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGlucHV0VHlwZSA9PT0gJ2RhdGUnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmZvcm1hdFNlcnZpY2UuZm9ybWF0KHZhbHVlLCBGb3JtYXREaXJlY3RpdmUuREFURUZPUk1BVCwgZmFsc2UpO1xyXG4gICAgICAgICAgICB0aGlzLl9yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICd2YWx1ZScsIGRhdGEpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoaW5wdXRUeXBlID09PSAndGltZScpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZm9ybWF0U2VydmljZS5mb3JtYXQodmFsdWUsIEZvcm1hdERpcmVjdGl2ZS5USU1FRk9STUFULCBmYWxzZSk7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ3ZhbHVlJywgZGF0YSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChpbnB1dFR5cGUgPT09ICdtb250aCcpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZm9ybWF0U2VydmljZS5mb3JtYXQodmFsdWUsIEZvcm1hdERpcmVjdGl2ZS5NT05USEZPUk1BVCwgZmFsc2UpO1xyXG4gICAgICAgICAgICB0aGlzLl9yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICd2YWx1ZScsIGRhdGEpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoaW5wdXRUeXBlID09PSAnd2VlaycpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZm9ybWF0U2VydmljZS5mb3JtYXQodmFsdWUsIEZvcm1hdERpcmVjdGl2ZS5XRUVLRk9STUFULCBmYWxzZSk7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ3ZhbHVlJywgZGF0YSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChpbnB1dFR5cGUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB2YWx1ZT9uZXcgSW50bC5OdW1iZXJGb3JtYXQoKS5mb3JtYXQodmFsdWUpOicnO1xyXG4gICAgICAgICAgICB0aGlzLl9yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICd2YWx1ZScsIGRhdGEpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoaW5wdXRUeXBlID09PSAnZW1haWwnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ3ZhbHVlJywgdmFsdWUpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgdGhpcy5mb3JtYXQpIHtcclxuICAgICAgICAgICAgbGV0IGRhdGEgPSB2YWx1ZTtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmZpbmRtb2RlKSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhID0gaW5wdXRUeXBlICA9PT0gJ251bWJlcicgJiYgZGF0YS50b1N0cmluZygpLmxlbmd0aCA+PSB0aGlzLmZvcm1hdC5tYXhMZW5ndGggPyBkYXRhLnRvU3RyaW5nKCkuc3Vic3RyaW5nKDAsIHRoaXMuZm9ybWF0Lm1heExlbmd0aCkgOiBkYXRhO1xyXG4gICAgICAgICAgICAgICAgbGV0IHVzZUVkaXQgPSAhdGhpcy5mb3JtYXQuZGlzcGxheTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmZvcm1hdC5lZGl0ICYmICF0aGlzLmZvcm1hdC5pc01hc2sgJiYgdGhpcy5oYXNGb2N1cykgdXNlRWRpdCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLmZvcm1hdFNlcnZpY2UuZm9ybWF0KGRhdGEsIHRoaXMuZm9ybWF0LCB1c2VFZGl0KTtcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChkYXRhICYmIHRoaXMuZm9ybWF0LnR5cGUgPT09ICdURVhUJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZvcm1hdC51cHBlcmNhc2UpIGRhdGEgPSBkYXRhLnRvVXBwZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5mb3JtYXQubG93ZXJjYXNlKSBkYXRhID0gZGF0YS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ3ZhbHVlJywgZGF0YSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAndmFsdWUnLCB2YWx1ZSA/IHZhbHVlIDogJycpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFR5cGUoKTogc3RyaW5nIHtcclxuICAgICAgICBjb25zdCB0eXBlID0gdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnR5cGUgYXMgc3RyaW5nO1xyXG4gICAgICAgIHJldHVybiB0eXBlP3R5cGUudG9Mb2NhbGVMb3dlckNhc2UoKTondGV4dCc7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRGb3JtYXQoKSB7XHJcbiAgICAgICAgdGhpcy5saXN0ZW5lcnMuZm9yRWFjaChsRm4gPT4gbEZuKCkpO1xyXG4gICAgICAgIHRoaXMubGlzdGVuZXJzID0gW107XHJcbiAgICAgICAgaWYgKHRoaXMuZm9ybWF0KSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5maW5kbW9kZSAmJiAodGhpcy5mb3JtYXQudXBwZXJjYXNlIHx8IHRoaXMuZm9ybWF0Lmxvd2VyY2FzZSkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXJzLnB1c2godGhpcy5fcmVuZGVyZXIubGlzdGVuKHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ2lucHV0JywgKCkgPT4gdGhpcy51cHBlck9yTG93ZXJDYXNlKCkpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGhpcy5mb3JtYXQuaXNOdW1iZXJWYWxpZGF0b3IgfHwgdGhpcy5mb3JtYXQudHlwZSA9PT0gJ05VTUJFUicgfHwgdGhpcy5mb3JtYXQudHlwZSA9PT0gJ0lOVEVHRVInKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVycy5wdXNoKHRoaXMuX3JlbmRlcmVyLmxpc3Rlbih0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICdrZXlwcmVzcycsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaXNLZXlQcmVzc0V2ZW50RmlyZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdFNlcnZpY2UudGVzdEZvck51bWJlcnNPbmx5KGV2ZW50LCBudWxsLCB0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsIHRoaXMuZmluZG1vZGUsIHRydWUsIHRoaXMuZm9ybWF0LCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVycy5wdXNoKHRoaXMuX3JlbmRlcmVyLmxpc3Rlbih0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICdpbnB1dCcsIChldmVudCkgPT4gdGhpcy5pbnB1dEZpcmVkRm9yTnVtYmVyc0NoZWNrKGV2ZW50KSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZvcm1hdC5tYXhMZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5maW5kbW9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldEF0dHJpYnV0ZSh0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICdtYXhsZW5ndGgnLCB0aGlzLmZvcm1hdC5tYXhMZW5ndGggKyAnJyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnJlbW92ZUF0dHJpYnV0ZSh0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICdtYXhsZW5ndGgnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZmluZG1vZGUgJiYgdGhpcy5mb3JtYXQuaXNNYXNrKSB7XHJcbiAgICAgICAgICAgICAgICBuZXcgTWFza0Zvcm1hdCh0aGlzLmZvcm1hdCwgdGhpcy5fcmVuZGVyZXIsIHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgdGhpcy5mb3JtYXRTZXJ2aWNlLCB0aGlzLmRvYyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy53cml0ZVZhbHVlKHRoaXMucmVhbFZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gbG93ZXIgYW5kIHVwcGVyIGNhc2UgaGFuZGxpbmdcclxuXHJcbiAgICBwcml2YXRlIHVwcGVyT3JMb3dlckNhc2UoKSB7XHJcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudDtcclxuICAgICAgICBjb25zdCBjYXJldFBvcyA9IGVsZW1lbnQuc2VsZWN0aW9uU3RhcnQ7XHJcbiAgICAgICAgZWxlbWVudC52YWx1ZSA9IHRoaXMuZm9ybWF0LnVwcGVyY2FzZSA/IGVsZW1lbnQudmFsdWUudG9VcHBlckNhc2UoKSA6IGVsZW1lbnQudmFsdWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICBlbGVtZW50LnNldFNlbGVjdGlvblJhbmdlKGNhcmV0UG9zLCBjYXJldFBvcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbnB1dEZpcmVkRm9yTnVtYmVyc0NoZWNrKGV2ZW50OiBFdmVudCkge1xyXG4gICAgICAgIGxldCBjdXJyZW50VmFsdWUgPSB0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQudmFsdWU7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5pc0tleVByZXNzRXZlbnRGaXJlZCAmJiAoZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS50YWdOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICdJTlBVVCcpIHtcclxuICAgICAgICAgICAgLy8gZ2V0IGluc2VydGVkIGNoYXJzXHJcbiAgICAgICAgICAgIGNvbnN0IGluc2VydGVkID0gdGhpcy5maW5kRGVsdGEoY3VycmVudFZhbHVlLCB0aGlzLm9sZElucHV0VmFsdWUpO1xyXG4gICAgICAgICAgICAvLyBnZXQgcmVtb3ZlZCBjaGFyc1xyXG4gICAgICAgICAgICBjb25zdCByZW1vdmVkID0gdGhpcy5maW5kRGVsdGEodGhpcy5vbGRJbnB1dFZhbHVlLCBjdXJyZW50VmFsdWUpO1xyXG4gICAgICAgICAgICAvLyBkZXRlcm1pbmUgaWYgdXNlciBwYXN0ZWQgY29udGVudFxyXG4gICAgICAgICAgICBjb25zdCBwYXN0ZWQgPSBpbnNlcnRlZC5sZW5ndGggPiAxIHx8ICghaW5zZXJ0ZWQgJiYgIXJlbW92ZWQpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCFwYXN0ZWQgJiYgIXJlbW92ZWQpIHtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5mb3JtYXRTZXJ2aWNlLnRlc3RGb3JOdW1iZXJzT25seShldmVudCwgaW5zZXJ0ZWQsIHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgdGhpcy5maW5kbW9kZSwgdHJ1ZSwgdGhpcy5mb3JtYXQsIHRydWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gdGhpcy5vbGRJbnB1dFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvL0lmIG51bWJlciB2YWxpZGF0b3IsIGNoZWNrIGFsbCBjaGFycyBpbiBzdHJpbmcgYW5kIGV4dHJhY3Qgb25seSB0aGUgdmFsaWQgY2hhcnMuXHJcbiAgICAgICAgICAgIGlmICgoZXZlbnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQpLnR5cGUudG9VcHBlckNhc2UoKSA9PT0gJ05VTUJFUicgfHwgdGhpcy5mb3JtYXQudHlwZSA9PT0gJ05VTUJFUicgfHwgdGhpcy5mb3JtYXQudHlwZSA9PT0gJ0lOVEVHRVInIHx8IHRoaXMuZm9ybWF0LmlzTnVtYmVyVmFsaWRhdG9yKSB7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSB0aGlzLmdldE51bWJlcnNGcm9tU3RyaW5nKGV2ZW50LCBjdXJyZW50VmFsdWUsIHRoaXMub2xkSW5wdXRWYWx1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgIT09IHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudC52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnZhbHVlID0gY3VycmVudFZhbHVlO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIC8vIGRldGVjdCBJRTggYW5kIGFib3ZlLCBhbmQgRWRnZTsgY2FsbCBvbiBjaGFuZ2UgbWFudWFsbHkgYmVjYXVzZSBvZiBodHRwczovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTA4MThcclxuICAgICAgICAgICAgICAgIC8vIGlmICgvTVNJRS8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSB8fCAvcnY6MTEuMC9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCkgfHwgL0VkZ2UvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHtcclxuICAgICAgICAgICAgICAgIC8vIFx0dmFyIGNoYW5nZU9uQmx1ckZvcklFID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBcdFx0IGVsZW1lbnQuY2hhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICAvLyBcdFx0IGVsZW1lbnQub2ZmKFwiYmx1clwiLCBjYWxsQ2hhbmdlT25CbHVyKTtcclxuICAgICAgICAgICAgICAgIC8vIFx0IH1cclxuICAgICAgICAgICAgICAgIC8vIFx0IGVsZW1lbnQub24oXCJibHVyXCIsIGNoYW5nZU9uQmx1ckZvcklFKTtcclxuICAgICAgICAgICAgICAgIC8vIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5vbGRJbnB1dFZhbHVlID0gY3VycmVudFZhbHVlO1xyXG4gICAgICAgICAgICB0aGlzLmlzS2V5UHJlc3NFdmVudEZpcmVkID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pc0tleVByZXNzRXZlbnRGaXJlZCkge1xyXG4gICAgICAgICAgICB0aGlzLm9sZElucHV0VmFsdWUgPSBjdXJyZW50VmFsdWU7XHJcbiAgICAgICAgICAgIHRoaXMuaXNLZXlQcmVzc0V2ZW50RmlyZWQgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBmaW5kRGVsdGEodmFsdWU6IHN0cmluZywgcHJldlZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCBkZWx0YSA9ICcnO1xyXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBwcmV2VmFsdWUgPT09ICdzdHJpbmcnICYmIHZhbHVlLmxlbmd0aCA+PSBwcmV2VmFsdWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN0ciA9IHZhbHVlLnN1YnN0cigwLCBpKSArIHZhbHVlLnN1YnN0cihpICsgdmFsdWUubGVuZ3RoIC0gcHJldlZhbHVlLmxlbmd0aCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3RyID09PSBwcmV2VmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBkZWx0YSA9IHZhbHVlLnN1YnN0cihpLCB2YWx1ZS5sZW5ndGggLSBwcmV2VmFsdWUubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZGVsdGE7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXROdW1iZXJzRnJvbVN0cmluZyhlOiBFdmVudCwgY3VycmVudFZhbHVlOiBzdHJpbmcsIG9sZElucHV0VmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIGlmIChvbGRJbnB1dFZhbHVlID09PSBjdXJyZW50VmFsdWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRWYWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHN0cmlwcGVkID0gJyc7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjdXJyZW50VmFsdWUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZm9ybWF0U2VydmljZS50ZXN0Rm9yTnVtYmVyc09ubHkoZSwgY3VycmVudFZhbHVlLmNoYXJBdChpKSwgdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCB0aGlzLmZpbmRtb2RlLCB0cnVlLCB0aGlzLmZvcm1hdCwgdHJ1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHN0cmlwcGVkID0gc3RyaXBwZWQgKyBjdXJyZW50VmFsdWUuY2hhckF0KGkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0cmlwcGVkLmxlbmd0aCA9PT0gdGhpcy5mb3JtYXQubWF4TGVuZ3RoKSBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc3RyaXBwZWQ7XHJcbiAgICB9XHJcbn1cclxuXHJcblxyXG4iXX0=
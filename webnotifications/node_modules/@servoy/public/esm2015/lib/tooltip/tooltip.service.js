import { DOCUMENT } from '@angular/common';
import { Inject, Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "../services/windowref.service";
export class TooltipService {
    constructor(_doc, windowRefService) {
        this.windowRefService = windowRefService;
        this.tipmousemove = (e) => {
            if (e.pageX || e.pageY) {
                this.tipmousemouveEventIsPage = true;
                this.tipmousemouveEventX = e.pageX;
                this.tipmousemouveEventY = e.pageY;
            }
            else if (e.clientX || e.clientY) {
                this.tipmousemouveEventIsPage = false;
                this.tipmousemouveEventX = e.clientX;
                this.tipmousemouveEventY = e.clientY;
            }
        };
        this.isTooltipActive = new Subject();
        this.doc = _doc;
    }
    showTooltip(event, message, initialDelay, dismissDelay) {
        let e = event;
        if (!e)
            e = this.windowRefService.nativeWindow.event;
        let targ;
        if (e.target)
            targ = e.target;
        else if (e.srcElement)
            targ = e.srcElement;
        if (targ.nodeType === 3) // defeat Safari bug
            targ = targ.parentNode;
        if (targ.tagName && targ.tagName.toLowerCase() === 'option') { // stop tooltip if over option element
            this.hideTooltip();
            return;
        }
        const tDiv = this.getTooltipDiv();
        tDiv.innerHTML = message;
        tDiv.style.zIndex = '1600';
        tDiv.style.width = '';
        tDiv.style.overflow = 'hidden';
        this.tipmousemove(e);
        if (this.doc.addEventListener) {
            this.doc.addEventListener('mousemove', this.tipmousemove, false);
        }
        this.tipInitialTimeout = setTimeout(() => this.adjustAndShowTooltip(dismissDelay), initialDelay);
    }
    hideTooltip() {
        this.internalHideTooltip();
    }
    getTooltipDiv() {
        if (!this.tooltipDiv) {
            this.tooltipDiv = this.doc.createElement('div');
            this.tooltipDiv.id = 'mktipmsg';
            this.tooltipDiv.className = 'mktipmsg tooltip-inner'; // tooltip-inner class is also used by ui-bootstrap-tpls-0.10.0
            this.doc.getElementsByTagName('body')[0].appendChild(this.tooltipDiv);
        }
        return this.tooltipDiv;
    }
    adjustAndShowTooltip(dismissDelay) {
        let x = 0;
        let y = 0;
        if (this.tipmousemouveEventX || this.tipmousemouveEventY) {
            if (this.tipmousemouveEventIsPage) {
                x = this.tipmousemouveEventX;
                y = this.tipmousemouveEventY;
            }
            else {
                x = this.tipmousemouveEventX + this.doc.body.scrollLeft + this.doc.documentElement.scrollLeft;
                y = this.tipmousemouveEventY + this.doc.body.scrollTop + this.doc.documentElement.scrollTop;
            }
        }
        let wWidth = 0;
        let wHeight = 0;
        if (typeof (this.windowRefService.nativeWindow.innerWidth) == 'number') {
            //Non-IE
            wWidth = this.windowRefService.nativeWindow.innerWidth;
            wHeight = this.windowRefService.nativeWindow.innerHeight;
        }
        else if (this.doc.documentElement && (this.doc.documentElement.clientWidth || this.doc.documentElement.clientHeight)) {
            //IE 6+ in 'standards compliant mode'
            wWidth = this.doc.documentElement.clientWidth;
            wHeight = this.doc.documentElement.clientHeight;
        }
        const tDiv = this.getTooltipDiv();
        tDiv.style.left = x + 10 + 'px';
        tDiv.style.top = y + 10 + 'px';
        tDiv.style.display = 'block';
        const tooltipOffsetWidth = x + 10 + tDiv.offsetWidth;
        if (wWidth < tooltipOffsetWidth) {
            let newLeft = x - 10 - tDiv.offsetWidth;
            if (newLeft < 0) {
                newLeft = 0;
                tDiv.style.width = x - 10 + 'px';
            }
            if (newLeft === 0)
                newLeft = tDiv.offsetWidth;
            tDiv.style.left = newLeft + 'px';
        }
        const tooltipOffsetHeight = y + 10 + tDiv.offsetHeight;
        if (wHeight < tooltipOffsetHeight) {
            const newTop = y - 10 - tDiv.offsetHeight;
            tDiv.style.top = newTop + 'px';
        }
        this.isTooltipActive.next(true);
        this.tipTimeout = setTimeout(() => this.hideTooltip(), dismissDelay);
    }
    internalHideTooltip() {
        if (this.doc.removeEventListener)
            this.doc.removeEventListener('mousemove', this.tipmousemove, false);
        clearTimeout(this.tipInitialTimeout);
        clearTimeout(this.tipTimeout);
        const tDiv = this.getTooltipDiv();
        tDiv.style.display = 'none';
        this.isTooltipActive.next(false);
    }
}
TooltipService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: TooltipService, deps: [{ token: DOCUMENT }, { token: i1.WindowRefService }], target: i0.ɵɵFactoryTarget.Injectable });
TooltipService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: TooltipService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: TooltipService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }, { type: i1.WindowRefService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9vbHRpcC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvc2Vydm95LXB1YmxpYy9zcmMvbGliL3Rvb2x0aXAvdG9vbHRpcC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDOzs7QUFJL0IsTUFBTSxPQUFPLGNBQWM7SUFTdkIsWUFBOEIsSUFBUyxFQUFVLGdCQUFrQztRQUFsQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBZ0QzRSxpQkFBWSxHQUFHLENBQUMsQ0FBYSxFQUFFLEVBQUU7WUFDckMsSUFBSSxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3BCLElBQUksQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUM7Z0JBQ3JDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO2dCQUNuQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQzthQUN0QztpQkFBTSxJQUFJLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRTtnQkFDL0IsSUFBSSxDQUFDLHdCQUF3QixHQUFHLEtBQUssQ0FBQztnQkFDdEMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUM7Z0JBQ3JDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDO2FBQ3hDO1FBQ0wsQ0FBQyxDQUFDO1FBekRFLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQUM5QyxJQUFJLENBQUMsR0FBRyxHQUFH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bUIsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN2RSxZQUFZLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDckMsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUU5QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQzVCLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JDLENBQUM7OzJHQXBJUSxjQUFjLGtCQVNILFFBQVE7K0dBVG5CLGNBQWM7MkZBQWQsY0FBYztrQkFEMUIsVUFBVTs7MEJBVU0sTUFBTTsyQkFBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFdpbmRvd1JlZlNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy93aW5kb3dyZWYuc2VydmljZSc7XHJcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRvb2x0aXBTZXJ2aWNlIHtcbiAgICBpc1Rvb2x0aXBBY3RpdmU6IFN1YmplY3Q8Ym9vbGVhbj47XG4gICAgdGlwSW5pdGlhbFRpbWVvdXQ6IGFueTtcbiAgICB0aXBUaW1lb3V0OiBhbnk7XG4gICAgcHJpdmF0ZSB0b29sdGlwRGl2OiBIVE1MRGl2RWxlbWVudDtcbiAgICBwcml2YXRlIHRpcG1vdXNlbW91dmVFdmVudFg6IGFueTtcbiAgICBwcml2YXRlIHRpcG1vdXNlbW91dmVFdmVudFk6IGFueTtcbiAgICBwcml2YXRlIHRpcG1vdXNlbW91dmVFdmVudElzUGFnZTogYm9vbGVhbjtcclxuICAgIHByaXZhdGUgZG9jOiBEb2N1bWVudDtcbiAgICBjb25zdHJ1Y3RvcihASW5qZWN0KERPQ1VNRU5UKSBfZG9jOiBhbnksIHByaXZhdGUgd2luZG93UmVmU2VydmljZTogV2luZG93UmVmU2VydmljZSkge1xuICAgICAgICB0aGlzLmlzVG9vbHRpcEFjdGl2ZSA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XHJcbiAgICAgICAgdGhpcy5kb2MgPSBfZG9jO1xuICAgIH1cblxyXG5cclxuICAgIHB1YmxpYyBzaG93VG9vbHRpcChldmVudDogTW91c2VFdmVudCwgbWVzc2FnZTogc3RyaW5nLCBpbml0aWFsRGVsYXk6IG51bWJlciwgZGlzbWlzc0RlbGF5OiBudW1iZXIpIHtcclxuICAgICAgICBsZXQgZSA9IGV2ZW50O1xyXG4gICAgICAgIGlmICghZSkgZSA9IHRoaXMud2luZG93UmVmU2VydmljZS5uYXRpdmVXaW5kb3cuZXZlbnQgYXMgTW91c2VFdmVudDtcclxuXHJcbiAgICAgICAgbGV0IHRhcmc7XHJcbiAgICAgICAgaWYgKGUudGFyZ2V0KSB0YXJnID0gZS50YXJnZXQ7XHJcbiAgICAgICAgZWxzZSBpZiAoZS5zcmNFbGVtZW50KSB0YXJnID0gZS5zcmNFbGVtZW50O1xyXG4gICAgICAgIGlmICh0YXJnLm5vZGVUeXBlID09PSAzKSAvLyBkZWZlYXQgU2FmYXJpIGJ1Z1xyXG4gICAgICAgICAgICB0YXJnID0gdGFyZy5wYXJlbnROb2RlO1xyXG5cclxuICAgICAgICBpZiAodGFyZy50YWdOYW1lICYmIHRhcmcudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnb3B0aW9uJykgeyAvLyBzdG9wIHRvb2x0aXAgaWYgb3ZlciBvcHRpb24gZWxlbWVudFxyXG4gICAgICAgICAgICB0aGlzLmhpZGVUb29sdGlwKCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHREaXYgPSB0aGlzLmdldFRvb2x0aXBEaXYoKTtcclxuICAgICAgICB0RGl2LmlubmVySFRNTCA9IG1lc3NhZ2U7XHJcbiAgICAgICAgdERpdi5zdHlsZS56SW5kZXggPSAnMTYwMCc7XHJcbiAgICAgICAgdERpdi5zdHlsZS53aWR0aCA9ICcnO1xyXG4gICAgICAgIHREaXYuc3R5bGUub3ZlcmZsb3cgPSAnaGlkZGVuJztcclxuXHJcbiAgICAgICAgdGhpcy50aXBtb3VzZW1vdmUoZSk7XHJcbiAgICAgICAgaWYgKHRoaXMuZG9jLmFkZEV2ZW50TGlzdGVuZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5kb2MuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy50aXBtb3VzZW1vdmUsIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy50aXBJbml0aWFsVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5hZGp1c3RBbmRTaG93VG9vbHRpcChkaXNtaXNzRGVsYXkpLCBpbml0aWFsRGVsYXkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBoaWRlVG9vbHRpcCgpIHtcclxuICAgICAgICB0aGlzLmludGVybmFsSGlkZVRvb2x0aXAoKTtcclxuICAgIH1cclxuXG4gICAgcHJpdmF0ZSBnZXRUb29sdGlwRGl2KCk6IEhUTUxEaXZFbGVtZW50IHtcbiAgICAgICAgaWYgKCF0aGlzLnRvb2x0aXBEaXYpIHtcbiAgICAgICAgICAgIHRoaXMudG9vbHRpcERpdiA9IHRoaXMuZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgdGhpcy50b29sdGlwRGl2LmlkID0gJ21rdGlwbXNnJztcbiAgICAgICAgICAgIHRoaXMudG9vbHRpcERpdi5jbGFzc05hbWUgPSAnbWt0aXBtc2cgdG9vbHRpcC1pbm5lcic7IC8vIHRvb2x0aXAtaW5uZXIgY2xhc3MgaXMgYWxzbyB1c2VkIGJ5IHVpLWJvb3RzdHJhcC10cGxzLTAuMTAuMFxuICAgICAgICAgICAgdGhpcy5kb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXS5hcHBlbmRDaGlsZCh0aGlzLnRvb2x0aXBEaXYpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnRvb2x0aXBEaXY7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0aXBtb3VzZW1vdmUgPSAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICBpZiAoZS5wYWdlWCB8fCBlLnBhZ2VZKSB7XG4gICAgICAgICAgICB0aGlzLnRpcG1vdXNlbW91dmVFdmVudElzUGFnZSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnRpcG1vdXNlbW91dmVFdmVudFggPSBlLnBhZ2VYO1xuICAgICAgICAgICAgdGhpcy50aXBtb3VzZW1vdXZlRXZlbnRZID0gZS5wYWdlWTtcbiAgICAgICAgfSBlbHNlIGlmIChlLmNsaWVudFggfHwgZS5jbGllbnRZKSB7XG4gICAgICAgICAgICB0aGlzLnRpcG1vdXNlbW91dmVFdmVudElzUGFnZSA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy50aXBtb3VzZW1vdXZlRXZlbnRYID0gZS5jbGllbnRYO1xuICAgICAgICAgICAgdGhpcy50aXBtb3VzZW1vdXZlRXZlbnRZID0gZS5jbGllbnRZO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgYWRqdXN0QW5kU2hvd1Rvb2x0aXAoZGlzbWlzc0RlbGF5OiBudW1iZXIpIHtcbiAgICAgICAgbGV0IHggPSAwO1xuICAgICAgICBsZXQgeSA9IDA7XG5cbiAgICAgICAgaWYgKHRoaXMudGlwbW91c2Vtb3V2ZUV2ZW50WCB8fCB0aGlzLnRpcG1vdXNlbW91dmVFdmVudFkpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnRpcG1vdXNlbW91dmVFdmVudElzUGFnZSkge1xuICAgICAgICAgICAgICAgIHggPSB0aGlzLnRpcG1vdXNlbW91dmVFdmVudFg7XG4gICAgICAgICAgICAgICAgeSA9IHRoaXMudGlwbW91c2Vtb3V2ZUV2ZW50WTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgeCA9IHRoaXMudGlwbW91c2Vtb3V2ZUV2ZW50WCArIHRoaXMuZG9jLmJvZHkuc2Nyb2xsTGVmdCArIHRoaXMuZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0O1xuICAgICAgICAgICAgICAgIHkgPSB0aGlzLnRpcG1vdXNlbW91dmVFdmVudFkgKyB0aGlzLmRvYy5ib2R5LnNjcm9sbFRvcCArIHRoaXMuZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3A7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgd1dpZHRoID0gMDsgbGV0IHdIZWlnaHQgPSAwO1xuICAgICAgICBpZiAodHlwZW9mICggdGhpcy53aW5kb3dSZWZTZXJ2aWNlLm5hdGl2ZVdpbmRvdy5pbm5lcldpZHRoKSA9PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgLy9Ob24tSUVcbiAgICAgICAgICAgIHdXaWR0aCA9ICB0aGlzLndpbmRvd1JlZlNlcnZpY2UubmF0aXZlV2luZG93LmlubmVyV2lkdGg7XG4gICAgICAgICAgICB3SGVpZ2h0ID0gIHRoaXMud2luZG93UmVmU2VydmljZS5uYXRpdmVXaW5kb3cuaW5uZXJIZWlnaHQ7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5kb2MuZG9jdW1lbnRFbGVtZW50ICYmICh0aGlzLmRvYy5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGggfHwgdGhpcy5kb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkpIHtcbiAgICAgICAgICAgIC8vSUUgNisgaW4gJ3N0YW5kYXJkcyBjb21wbGlhbnQgbW9kZSdcbiAgICAgICAgICAgIHdXaWR0aCA9IHRoaXMuZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aDtcbiAgICAgICAgICAgIHdIZWlnaHQgPSB0aGlzLmRvYy5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0O1xuICAgICAgICB9XG5cblxuICAgICAgICBjb25zdCB0RGl2ID0gdGhpcy5nZXRUb29sdGlwRGl2KCk7XG4gICAgICAgIHREaXYuc3R5bGUubGVmdCA9IHggKyAxMCArICdweCc7XG4gICAgICAgIHREaXYuc3R5bGUudG9wID0geSArIDEwICsgJ3B4JztcbiAgICAgICAgdERpdi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgY29uc3QgdG9vbHRpcE9mZnNldFdpZHRoID0geCArIDEwICsgdERpdi5vZmZzZXRXaWR0aDtcblxuICAgICAgICBpZiAod1dpZHRoIDwgdG9vbHRpcE9mZnNldFdpZHRoKSB7XG4gICAgICAgICAgICBsZXQgbmV3TGVmdCA9IHggLSAxMCAtIHREaXYub2Zmc2V0V2lkdGg7XG4gICAgICAgICAgICBpZiAobmV3TGVmdCA8IDApIHtcbiAgICAgICAgICAgICAgICBuZXdMZWZ0ID0gMDtcbiAgICAgICAgICAgICAgICB0RGl2LnN0eWxlLndpZHRoID0geCAtIDEwICsgJ3B4JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChuZXdMZWZ0ID09PSAwKVxuICAgICAgICAgICAgICAgIG5ld0xlZnQgPSB0RGl2Lm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgdERpdi5zdHlsZS5sZWZ0ID0gbmV3TGVmdCArICdweCc7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB0b29sdGlwT2Zmc2V0SGVpZ2h0ID0geSArIDEwICsgdERpdi5vZmZzZXRIZWlnaHQ7XG4gICAgICAgIGlmICh3SGVpZ2h0IDwgdG9vbHRpcE9mZnNldEhlaWdodCkge1xuICAgICAgICAgICAgY29uc3QgbmV3VG9wID0geSAtIDEwIC0gdERpdi5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICB0RGl2LnN0eWxlLnRvcCA9IG5ld1RvcCArICdweCc7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pc1Rvb2x0aXBBY3RpdmUubmV4dCh0cnVlKTtcbiAgICAgICAgdGhpcy50aXBUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLmhpZGVUb29sdGlwKCksIGRpc21pc3NEZWxheSk7XG5cblxuICAgIH1cblxyXG4gICAgcHJpdmF0ZSBpbnRlcm5hbEhpZGVUb29sdGlwKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRvYy5yZW1vdmVFdmVudExpc3RlbmVyKVxyXG4gICAgICAgICAgIHRoaXMuZG9jLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMudGlwbW91c2Vtb3ZlLCBmYWxzZSk7XHJcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGlwSW5pdGlhbFRpbWVvdXQpO1xyXG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpcFRpbWVvdXQpO1xyXG5cclxuICAgICAgICBjb25zdCB0RGl2ID0gdGhpcy5nZXRUb29sdGlwRGl2KCk7XHJcbiAgICAgICAgdERpdi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xyXG4gICAgICAgIHRoaXMuaXNUb29sdGlwQWN0aXZlLm5leHQoZmFsc2UpO1xyXG4gICAgfVxufVxuXG5cblxuXG5cbiJdfQ==
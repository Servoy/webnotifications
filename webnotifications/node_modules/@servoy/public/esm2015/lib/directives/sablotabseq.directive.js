import { Directive, Input, HostBinding, HostListener } from '@angular/core';
import * as i0 from "@angular/core";
export class SabloTabseq {
    constructor(_elemRef, cdRef) {
        this._elemRef = _elemRef;
        this.cdRef = cdRef;
        this.designChildIndexToArrayPosition = {};
        this.designChildTabSeq = []; // contains ordered numbers that will be keys in 'runtimeChildIndexes'; can have duplicates
        this.runtimeChildIndexes = {}; // map designChildIndex[i] -> runtimeIndex for child or designChildIndex[i] -> [runtimeIndex1, runtimeIndex2] in case there are multiple equal design time indexes
    }
    // handle event: Child Servoy Tab Sequence registered
    registerChildHandler(designChildIndex, runtimeChildIndex, event) {
        if (this.designTabSeq === -2 || designChildIndex === -2) {
            this.recalculateIndexesHandler(designChildIndex ? designChildIndex : 0, false);
            event.stopPropagation();
            return false;
        }
        // insert it sorted
        let posInDesignArray = 0;
        for (let tz = 0; tz < this.designChildTabSeq.length && this.designChildTabSeq[tz] < designChildIndex; tz++) {
            posInDesignArray = tz + 1;
        }
        if (posInDesignArray === this.designChildTabSeq.length || this.designChildTabSeq[posInDesignArray] > designChildIndex) {
            this.designChildTabSeq.splice(posInDesignArray, 0, designChildIndex);
            // always keep in designChildIndexToArrayPosition[i] the first occurrance of design index i in the sorted designChildTabSeq array
            for (let tz = posInDesignArray; tz < this.designChildTabSeq.length; tz++) {
                this.designChildIndexToArrayPosition[this.designChildTabSeq[tz]] = tz;
            }
            this.runtimeChildIndexes[designChildIndex] = runtimeChildIndex;
        }
        else {
            // its == that means that we have dupliate design indexes; we treat this special - all same design index children as a list in one runtime index array cell
            if (!this.runtimeChildIndexes[designChildIndex].push) {
                this.runtimeChildIndexes[designChildIndex] = [this.runtimeChildIndexes[designChildIndex]];
            }
            this.runtimeChildIndexes[designChildIndex].push(runtimeChildIndex);
        }
        this.recalculateIndexesHandler(designChildIndex ? designChildIndex : 0, false);
        event.stopPropagation();
        return false;
    }
    unregisterChildHandler(designChildIndex, runtimeChildIndex, event) {
        if (this.designTabSeq === -2 || designChildIndex === -2) {
            event.stopPropagation();
            return false;
        }
        const posInDesignArray = this.designChildIndexToArrayPosition[designChildIndex];
        if (posInDesignArray !== undefined) {
            const keyInRuntimeArray = this.designChildTabSeq[posInDesignArray];
            const multipleEqualDesignValues = this.runtimeChildIndexes[keyInRuntimeArray].push;
            if (!multipleEqualDesignValues) {
                delete this.designChildIndexToArrayPosition[designChildIndex];
                for (const tmp in this.designChildIndexToArrayPosition) {
                    if (this.designChildIndexToArrayPosition[tmp] > posInDesignArray)
                        this.designChildIndexToArrayPosition[tmp]--;
                }
                this.designChildTabSeq.splice(posInDesignArray, 1);
                delete this.runtimeChildIndexes[keyInRuntimeArray];
            }
            else {
                this.runtimeChildIndexes[keyInRuntimeArray].splice(this.runtimeChildIndexes[keyInRuntimeArray].indexOf(runtimeChildIndex), 1);
                if (this.runtimeChildIndexes[keyInRuntimeArray].length === 1)
                    this.runtimeChildIndexes[keyInRuntimeArray] = this.runtimeChildIndexes[keyInRuntimeArray][0];
            }
        }
        event.stopPropagation();
        return false;
    }
    // handle event: child tree was now linked or some child needs extra indexes; runtime indexes can be computed starting at the given child;
    // recalculate Parent Servoy Tab Sequence
    recalculateIndexesHandler(designChildIndex, initialRootRecalculate, event) {
        if (this.designTabSeq === -2 || designChildIndex === -2) {
            if (event)
                event.stopPropagation();
            return false;
        }
        if (!this.initializing) {
            // a new child is ready/linked; recalculate tab indexes for it and after it
            const startIdx = (this.designChildIndexToArrayPosition && this.designChildIndexToArrayPosition[designChildIndex] !== undefined) ?
                this.designChildIndexToArrayPosition[designChildIndex] : 0;
            this.recalculateChildRuntimeIndexesStartingAt(startIdx, false);
        }
        else if (initialRootRecalculate) {
            // this is $rootScope (one $parent extra cause the directive creates it); we always assume a sabloTabseq directive is bound to it;
            // now that it is linked we can do initial calculation of tre
            this.runtimeIndex.startIndex = this.runtimeIndex.nextAvailableIndex = 1;
            this.recalculateChildRuntimeIndexesStartingAt(0, true);
        } // else wait for parent tabSeq directives to get linked as well
        if (event)
            event.stopPropagation();
        return false;
    }
    disableTabseq(event) {
        this.isEnabled = false;
        this.recalculateChildRuntimeIndexesStartingAt(0, true);
        event.stopPropagation();
        return false;
    }
    enableTabseq(event) {
        this.isEnabled = true;
        this.trigger(this._elemRef.nativeElement.parentNode, 'recalculatePSTS', [0, false]);
        event.stopPropagation();
        return false;
    }
    ngOnInit() {
        // called by angular in parents first then in children
        if (!this.designTabSeq)
            this.designTabSeq = 0;
        this.initializing = true;
        this.isEnabled = true;
        // runtime index -1 == SKIP focus traversal in browser
        // runtime index  0 == DEFAULT == design tab seq 0 (not tabIndex attr set to element or it's children)
        this.runtimeIndex = { startIndex: -1, nextAvailableIndex: -1, sablotabseq: this };
        // -1 runtime initially for all (in case some node in the tree has -2 design (skip) and children have >= 0,
        // at runtime all children should be excluded as wel)
        this.updateCurrentDomElTabIndex();
        // check to see if this is the top-most tabSeq container
        if (this.config && this.config.root) {
            // it's root tab seq container (so no parent); just do initial tree calculation
            this.recalculateIndexesHandler(0, true);
        }
        else {
            if (this.designTabSeq !== -2) {
                this.trigger(this._elemRef.nativeElement.parentNode, 'registerCSTS', [this.designTabSeq, this.runtimeIndex]);
            }
        }
    }
    ngOnChanges(changes) {
        const change = changes['designTabSeq'];
        if (change && !change.firstChange) {
            if (!(this.config && this.config.root)) {
                if (change.previousValue !== -2)
                    this.trigger(this._elemRef.nativeElement.parentNode, 'unregisterCSTS', [change.previousValue, this.runtimeIndex]);
                if (!this.designTabSeq)
                    this.designTabSeq = 0;
                this.runtimeIndex.startIndex = -1;
                this.runtimeIndex.nextAvailableIndex = -1;
                this.initializing = true;
                if (this.designTabSeq !== -2) {
                    this.trigger(this._elemRef.nativeElement.parentNode, 'registerCSTS', [this.designTabSeq, this.runtimeIndex]);
                    // here we could send [0] instead of [designTabSeq] - it would potentially calculate more but start again from first parent available index,
                    // not higher index (the end user behavior being the same)
                    this.trigger(this._elemRef.nativeElement.parentNode, 'recalculatePSTS', [this.designTabSeq]);
                }
                else {
                    this.updateCurrentDomElTabIndex(); // -1 runtime
                }
            }
        }
    }
    recalculateChildRuntimeIndexesStartingAt(posInDesignArray /*inclusive*/, triggeredByParent) {
        if (this.designTabSeq === -2)
            return;
        if (!this.isEnabled || this.runtimeIndex.startIndex === -1) {
            this.runtimeIndex.nextAvailableIndex = this.runtimeIndex.startIndex;
            this.runtimeIndex.startIndex = -1;
        }
        else if (this.designTabSeq === 0) {
            // this element doesn't set any tabIndex attribute (default behavior)
            this.runtimeIndex.nextAvailableIndex = this.runtimeIndex.startIndex;
            this.runtimeIndex.startIndex = 0;
        }
        else if (this.runtimeIndex.startIndex === 0) {
            this.runtimeIndex.nextAvailableIndex = 0;
        }
        else if (this.runtimeIndex.nextAvailableIndex === -1) {
            const reservedGap = (this.config && this.config.reservedGap) ? this.config.reservedGap : 0;
            this.runtimeIndex.nextAvailableIndex = this.runtimeIndex.startIndex + reservedGap;
        }
        if (posInDesignArray === 0)
            this.updateCurrentDomElTabIndex();
        let recalculateStartIndex = this.runtimeIndex.startIndex;
        if (posInDesignArray > 0 && posInDesignArray - 1 < this.designChildTabSeq.length) {
            const runtimeCI = this.runtimeChildIndexes[this.designChildTabSeq[posInDesignArray - 1]]; // this can be an array in case of multiple equal design indexes being siblings
            recalculateStartIndex = runtimeCI.push ? runtimeCI[runtimeCI.length - 1].nextAvailableIndex : runtimeCI.nextAvailableIndex;
        }
        for (let i = posInDesignArray; i < this.designChildTabSeq.length; i++) {
            const childRuntimeIndex = this.runtimeChildIndexes[this.designChildTabSeq[i]];
            if (childRuntimeIndex.push) {
                // multiple equal design time indexes as siblings
                let max = recalculateStartIndex;
                for (const k in childRuntimeIndex) {
                    if (childRuntimeIndex.hasOwnProperty(k)) {
                        childRuntimeIndex[k].startIndex = recalculateStartIndex;
                        // call recalculate on whole child; normally it only makes sense for same index siblings
                        // if they are not themselfes containers, just apply the given value
                        childRuntimeIndex[k].sablotabseq.recalculateChildRuntimeIndexesStartingAt(0, true);
                        if (max < childRuntimeIndex[k].nextAvailableIndex)
                            max = childRuntimeIndex[k].nextAvailableIndex;
                    }
                }
                recalculateStartIndex = max;
            }
            else {
                childRuntimeIndex.startIndex = recalculateStartIndex;
                childRuntimeIndex.sablotabseq.recalculateChildRuntimeIndexesStartingAt(0, true); // call recalculate on whole child
                recalculateStartIndex = childRuntimeIndex.nextAvailableIndex;
            }
        }
        if (this.initializing)
            this.initializing = undefined; // it's now considered initialized as first runtime index caluculation is done
        let parentRecalculateNeeded;
        if (this.runtimeIndex.startIndex !== 0 && this.runtimeIndex.startIndex !== -1) {
            const ownTabIndexBump = this.hasOwnTabIndex() ? 1 : 0;
            parentRecalculateNeeded = (this.runtimeIndex.nextAvailableIndex < recalculateStartIndex + ownTabIndexBump);
            const reservedGap = (this.config && this.config.reservedGap) ? this.config.reservedGap : 0;
            if (parentRecalculateNeeded)
                this.runtimeIndex.nextAvailableIndex = recalculateStartIndex + reservedGap + ownTabIndexBump;
        }
        else {
            // start index 0 means default (no tabIndex attr. set)
            parentRecalculateNeeded = false;
        }
        // if this container now needs more tab indexes than it was reserved; a recalculate on parent needs to be triggered in this case
        if (parentRecalculateNeeded && !triggeredByParent)
            this.trigger(this._elemRef.nativeElement.parentNode, 'recalculatePSTS', [this.designTabSeq, false]);
    }
    hasOwnTabIndex() {
        return (!this.config || !(this.config.container || this.config.root));
    }
    updateCurrentDomElTabIndex() {
        if (this.hasOwnTabIndex()) {
            if (this.runtimeIndex.startIndex !== 0) {
                this.setDOMTabIndex(this.runtimeIndex.startIndex);
            }
            else {
                this.setDOMTabIndex(undefined);
            }
        }
    }
    setDOMTabIndex(tabindex) {
        this.tabindex = tabindex;
        this.cdRef.detectChanges();
    }
    trigger(target, event, arg) {
        const customEvent = new CustomEvent(event, {
            bubbles: true,
            detail: arg
        });
        target.dispatchEvent(customEvent);
    }
    ngOnDestroy() {
        // unregister current tabSeq from parent tabSeq container
        if (this._elemRef.nativeElement.parentNode) {
            this.trigger(this._elemRef.nativeElement.parentNode, 'unregisterCSTS', [this.designTabSeq, this.runtimeIndex]);
        }
    }
}
SabloTabseq.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: SabloTabseq, deps: [{ token: i0.ElementRef }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Directive });
SabloTabseq.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.0.2", type: SabloTabseq, selector: "[sabloTabseq]", inputs: { designTabSeq: ["sabloTabseq", "designTabSeq"], config: ["sabloTabseqConfig", "config"] }, host: { listeners: { "registerCSTS": "registerChildHandler($event.detail[0],$event.detail[1],$event)", "unregisterCSTS": "unregisterChildHandler($event.detail[0],$event.detail[1],$event)", "recalculatePSTS": "recalculateIndexesHandler($event.detail[0],$event.detail[1],$event)", "disableTabseq": "disableTabseq($event)", "enableTabseq": "enableTabseq($event)" }, properties: { "attr.tabindex": "this.tabindex" } }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: SabloTabseq, decorators: [{
            type: Directive,
            args: [{
                    selector: '[sabloTabseq]'
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.ChangeDetectorRef }]; }, propDecorators: { designTabSeq: [{
                type: Input,
                args: ['sabloTabseq']
            }], config: [{
                type: Input,
                args: ['sabloTabseqConfig']
            }], tabindex: [{
                type: HostBinding,
                args: ['attr.tabindex']
            }], registerChildHandler: [{
                type: HostListener,
                args: ['registerCSTS', ['$event.detail[0]', '$event.detail[1]', '$event']]
            }], unregisterChildHandler: [{
                type: HostListener,
                args: ['unregisterCSTS', ['$event.detail[0]', '$event.detail[1]', '$event']]
            }], recalculateIndexesHandler: [{
                type: HostListener,
                args: ['recalculatePSTS', ['$event.detail[0]', '$event.detail[1]', '$event']]
            }], disableTabseq: [{
                type: HostListener,
                args: ['disableTabseq', ['$event']]
            }], enableTabseq: [{
                type: HostListener,
                args: ['enableTabseq', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FibG90YWJzZXEuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvc2Vydm95LXB1YmxpYy9zcmMvbGliL2RpcmVjdGl2ZXMvc2FibG90YWJzZXEuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFVLFdBQVcsRUFBYyxZQUFZLEVBQTBELE1BQU0sZUFBZSxDQUFDOztBQUt4SixNQUFNLE9BQU8sV0FBVztJQWFwQixZQUFvQixRQUFvQixFQUFVLEtBQXdCO1FBQXRELGFBQVEsR0FBUixRQUFRLENBQVk7UUFBVSxVQUFLLEdBQUwsS0FBSyxDQUFtQjtRQVAxRSxvQ0FBK0IsR0FBRyxFQUFFLENBQUM7UUFDckMsc0JBQWlCLEdBQUcsRUFBRSxDQUFDLENBQUMsMkZBQTJGO1FBQ25ILHdCQUFtQixHQUFHLEVBQUUsQ0FBQyxDQUFDLGtLQUFrSztJQU01TCxDQUFDO0lBRUQscURBQXFEO0lBRXJELG9CQUFvQixDQUFDLGdCQUFnQixFQUFFLGlCQUFpQixFQUFFLEtBQUs7UUFDM0QsSUFBSSxJQUFJLENBQUMsWUFBWSxLQUFLLENBQUMsQ0FBQyxJQUFJLGdCQUFnQixLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ3JELElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUMvRSxLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDeEIsT0FBTyxLQUFLLENBQUM7U0FDaEI7UUFFRCxtQkFBbUI7UUFDbkIsSUFBSSxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7UUFDekIsS0FBSyxJQUFJLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLGlC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QjtnQkFDSSxRQUFRO3NCQUFyQyxXQUFXO3VCQUFDLGVBQWU7Z0JBYzVCLG9CQUFvQjtzQkFEbkIsWUFBWTt1QkFBQyxjQUFjLEVBQUUsQ0FBQyxrQkFBa0IsRUFBRSxrQkFBa0IsRUFBRSxRQUFRLENBQUM7Z0JBbUNoRixzQkFBc0I7c0JBRHJCLFlBQVk7dUJBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxrQkFBa0IsRUFBRSxrQkFBa0IsRUFBRSxRQUFRLENBQUM7Z0JBOEJsRix5QkFBeUI7c0JBRHhCLFlBQVk7dUJBQUMsaUJBQWlCLEVBQUUsQ0FBQyxrQkFBa0IsRUFBRSxrQkFBa0IsRUFBRSxRQUFRLENBQUM7Z0JBd0JuRixhQUFhO3NCQURaLFlBQVk7dUJBQUMsZUFBZSxFQUFFLENBQUMsUUFBUSxDQUFDO2dCQVN6QyxZQUFZO3NCQURYLFlBQVk7dUJBQUMsY0FBYyxFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBJbnB1dCwgT25Jbml0LCBIb3N0QmluZGluZywgRWxlbWVudFJlZiwgSG9zdExpc3RlbmVyLCBPbkRlc3Ryb3ksIENoYW5nZURldGVjdG9yUmVmLCBTaW1wbGVDaGFuZ2VzLCBPbkNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbc2FibG9UYWJzZXFdJ1xufSlcbmV4cG9ydCBjbGFzcyBTYWJsb1RhYnNlcSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuXG4gICAgQElucHV0KCdzYWJsb1RhYnNlcScpIGRlc2lnblRhYlNlcTogbnVtYmVyO1xuICAgIEBJbnB1dCgnc2FibG9UYWJzZXFDb25maWcnKSBjb25maWc6IGFueTtcbiAgICBASG9zdEJpbmRpbmcoJ2F0dHIudGFiaW5kZXgnKSB0YWJpbmRleDogbnVtYmVyO1xuXG4gICAgZGVzaWduQ2hpbGRJbmRleFRvQXJyYXlQb3NpdGlvbiA9IHt9O1xuICAgIGRlc2lnbkNoaWxkVGFiU2VxID0gW107IC8vIGNvbnRhaW5zIG9yZGVyZWQgbnVtYmVycyB0aGF0IHdpbGwgYmUga2V5cyBpbiAncnVudGltZUNoaWxkSW5kZXhlcyc7IGNhbiBoYXZlIGR1cGxpY2F0ZXNcbiAgICBydW50aW1lQ2hpbGRJbmRleGVzID0ge307IC8vIG1hcCBkZXNpZ25DaGlsZEluZGV4W2ldIC0+IHJ1bnRpbWVJbmRleCBmb3IgY2hpbGQgb3IgZGVzaWduQ2hpbGRJbmRleFtpXSAtPiBbcnVudGltZUluZGV4MSwgcnVudGltZUluZGV4Ml0gaW4gY2FzZSB0aGVyZSBhcmUgbXVsdGlwbGUgZXF1YWwgZGVzaWduIHRpbWUgaW5kZXhlc1xuICAgIHJ1bnRpbWVJbmRleDtcbiAgICBpbml0aWFsaXppbmc6IGJvb2xlYW47XG4gICAgaXNFbmFibGVkOiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfZWxlbVJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSBjZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYpIHtcbiAgICB9XG5cbiAgICAvLyBoYW5kbGUgZXZlbnQ6IENoaWxkIFNlcnZveSBUYWIgU2VxdWVuY2UgcmVnaXN0ZXJlZFxuICAgIEBIb3N0TGlzdGVuZXIoJ3JlZ2lzdGVyQ1NUUycsIFsnJGV2ZW50LmRldGFpbFswXScsICckZXZlbnQuZGV0YWlsWzFdJywgJyRldmVudCddKVxuICAgIHJlZ2lzdGVyQ2hpbGRIYW5kbGVyKGRlc2lnbkNoaWxkSW5kZXgsIHJ1bnRpbWVDaGlsZEluZGV4LCBldmVudCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodGhpcy5kZXNpZ25UYWJTZXEgPT09IC0yIHx8IGRlc2lnbkNoaWxkSW5kZXggPT09IC0yKSB7XG4gICAgICAgICAgICB0aGlzLnJlY2FsY3VsYXRlSW5kZXhlc0hhbmRsZXIoZGVzaWduQ2hpbGRJbmRleCA/IGRlc2lnbkNoaWxkSW5kZXggOiAwLCBmYWxzZSk7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGluc2VydCBpdCBzb3J0ZWRcbiAgICAgICAgbGV0IHBvc0luRGVzaWduQXJyYXkgPSAwO1xuICAgICAgICBmb3IgKGxldCB0eiA9IDA7IHR6IDwgdGhpcy5kZXNpZ25DaGlsZFRhYlNlcS5sZW5ndGggJiYgdGhpcy5kZXNpZ25DaGlsZFRhYlNlcVt0el0gPCBkZXNpZ25DaGlsZEluZGV4OyB0eisrKSB7XG4gICAgICAgICAgICBwb3NJbkRlc2lnbkFycmF5ID0gdHogKyAxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwb3NJbkRlc2lnbkFycmF5ID09PSB0aGlzLmRlc2lnbkNoaWxkVGFiU2VxLmxlbmd0aCB8fCB0aGlzLmRlc2lnbkNoaWxkVGFiU2VxW3Bvc0luRGVzaWduQXJyYXldID4gZGVzaWduQ2hpbGRJbmRleCkge1xuICAgICAgICAgICAgdGhpcy5kZXNpZ25DaGlsZFRhYlNlcS5zcGxpY2UocG9zSW5EZXNpZ25BcnJheSwgMCwgZGVzaWduQ2hpbGRJbmRleCk7XG5cbiAgICAgICAgICAgIC8vIGFsd2F5cyBrZWVwIGluIGRlc2lnbkNoaWxkSW5kZXhUb0FycmF5UG9zaXRpb25baV0gdGhlIGZpcnN0IG9jY3VycmFuY2Ugb2YgZGVzaWduIGluZGV4IGkgaW4gdGhlIHNvcnRlZCBkZXNpZ25DaGlsZFRhYlNlcSBhcnJheVxuICAgICAgICAgICAgZm9yIChsZXQgdHogPSBwb3NJbkRlc2lnbkFycmF5OyB0eiA8IHRoaXMuZGVzaWduQ2hpbGRUYWJTZXEubGVuZ3RoOyB0eisrKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZXNpZ25DaGlsZEluZGV4VG9BcnJheVBvc2l0aW9uW3RoaXMuZGVzaWduQ2hpbGRUYWJTZXFbdHpdXSA9IHR6O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5ydW50aW1lQ2hpbGRJbmRleGVzW2Rlc2lnbkNoaWxkSW5kZXhdID0gcnVudGltZUNoaWxkSW5kZXg7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBpdHMgPT0gdGhhdCBtZWFucyB0aGF0IHdlIGhhdmUgZHVwbGlhdGUgZGVzaWduIGluZGV4ZXM7IHdlIHRyZWF0IHRoaXMgc3BlY2lhbCAtIGFsbCBzYW1lIGRlc2lnbiBpbmRleCBjaGlsZHJlbiBhcyBhIGxpc3QgaW4gb25lIHJ1bnRpbWUgaW5kZXggYXJyYXkgY2VsbFxuICAgICAgICAgICAgaWYgKCF0aGlzLnJ1bnRpbWVDaGlsZEluZGV4ZXNbZGVzaWduQ2hpbGRJbmRleF0ucHVzaCkge1xuICAgICAgICAgICAgICAgIHRoaXMucnVudGltZUNoaWxkSW5kZXhlc1tkZXNpZ25DaGlsZEluZGV4XSA9IFt0aGlzLnJ1bnRpbWVDaGlsZEluZGV4ZXNbZGVzaWduQ2hpbGRJbmRleF1dO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5ydW50aW1lQ2hpbGRJbmRleGVzW2Rlc2lnbkNoaWxkSW5kZXhdLnB1c2gocnVudGltZUNoaWxkSW5kZXgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yZWNhbGN1bGF0ZUluZGV4ZXNIYW5kbGVyKGRlc2lnbkNoaWxkSW5kZXggPyBkZXNpZ25DaGlsZEluZGV4IDogMCwgZmFsc2UpO1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ3VucmVnaXN0ZXJDU1RTJywgWyckZXZlbnQuZGV0YWlsWzBdJywgJyRldmVudC5kZXRhaWxbMV0nLCAnJGV2ZW50J10pXG4gICAgdW5yZWdpc3RlckNoaWxkSGFuZGxlcihkZXNpZ25DaGlsZEluZGV4LCBydW50aW1lQ2hpbGRJbmRleCwgZXZlbnQpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMuZGVzaWduVGFiU2VxID09PSAtMiB8fCBkZXNpZ25DaGlsZEluZGV4ID09PSAtMikge1xuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwb3NJbkRlc2lnbkFycmF5ID0gdGhpcy5kZXNpZ25DaGlsZEluZGV4VG9BcnJheVBvc2l0aW9uW2Rlc2lnbkNoaWxkSW5kZXhdO1xuICAgICAgICBpZiAocG9zSW5EZXNpZ25BcnJheSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb25zdCBrZXlJblJ1bnRpbWVBcnJheSA9IHRoaXMuZGVzaWduQ2hpbGRUYWJTZXFbcG9zSW5EZXNpZ25BcnJheV07XG4gICAgICAgICAgICBjb25zdCBtdWx0aXBsZUVxdWFsRGVzaWduVmFsdWVzID0gdGhpcy5ydW50aW1lQ2hpbGRJbmRleGVzW2tleUluUnVudGltZUFycmF5XS5wdXNoO1xuICAgICAgICAgICAgaWYgKCFtdWx0aXBsZUVxdWFsRGVzaWduVmFsdWVzKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuZGVzaWduQ2hpbGRJbmRleFRvQXJyYXlQb3NpdGlvbltkZXNpZ25DaGlsZEluZGV4XTtcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHRtcCBpbiB0aGlzLmRlc2lnbkNoaWxkSW5kZXhUb0FycmF5UG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVzaWduQ2hpbGRJbmRleFRvQXJyYXlQb3NpdGlvblt0bXBdID4gcG9zSW5EZXNpZ25BcnJheSkgdGhpcy5kZXNpZ25DaGlsZEluZGV4VG9BcnJheVBvc2l0aW9uW3RtcF0tLTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5kZXNpZ25DaGlsZFRhYlNlcS5zcGxpY2UocG9zSW5EZXNpZ25BcnJheSwgMSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMucnVudGltZUNoaWxkSW5kZXhlc1trZXlJblJ1bnRpbWVBcnJheV07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMucnVudGltZUNoaWxkSW5kZXhlc1trZXlJblJ1bnRpbWVBcnJheV0uc3BsaWNlKHRoaXMucnVudGltZUNoaWxkSW5kZXhlc1trZXlJblJ1bnRpbWVBcnJheV0uaW5kZXhPZihydW50aW1lQ2hpbGRJbmRleCksIDEpO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnJ1bnRpbWVDaGlsZEluZGV4ZXNba2V5SW5SdW50aW1lQXJyYXldLmxlbmd0aCA9PT0gMSkgdGhpcy5ydW50aW1lQ2hpbGRJbmRleGVzW2tleUluUnVudGltZUFycmF5XSA9IHRoaXMucnVudGltZUNoaWxkSW5kZXhlc1trZXlJblJ1bnRpbWVBcnJheV1bMF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBoYW5kbGUgZXZlbnQ6IGNoaWxkIHRyZWUgd2FzIG5vdyBsaW5rZWQgb3Igc29tZSBjaGlsZCBuZWVkcyBleHRyYSBpbmRleGVzOyBydW50aW1lIGluZGV4ZXMgY2FuIGJlIGNvbXB1dGVkIHN0YXJ0aW5nIGF0IHRoZSBnaXZlbiBjaGlsZDtcbiAgICAvLyByZWNhbGN1bGF0ZSBQYXJlbnQgU2Vydm95IFRhYiBTZXF1ZW5jZVxuICAgIEBIb3N0TGlzdGVuZXIoJ3JlY2FsY3VsYXRlUFNUUycsIFsnJGV2ZW50LmRldGFpbFswXScsICckZXZlbnQuZGV0YWlsWzFdJywgJyRldmVudCddKVxuICAgIHJlY2FsY3VsYXRlSW5kZXhlc0hhbmRsZXIoZGVzaWduQ2hpbGRJbmRleCwgaW5pdGlhbFJvb3RSZWNhbGN1bGF0ZSwgZXZlbnQ/KTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aGlzLmRlc2lnblRhYlNlcSA9PT0gLTIgfHwgZGVzaWduQ2hpbGRJbmRleCA9PT0gLTIpIHtcbiAgICAgICAgICAgIGlmKGV2ZW50KSBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5pbml0aWFsaXppbmcpIHtcbiAgICAgICAgICAgIC8vIGEgbmV3IGNoaWxkIGlzIHJlYWR5L2xpbmtlZDsgcmVjYWxjdWxhdGUgdGFiIGluZGV4ZXMgZm9yIGl0IGFuZCBhZnRlciBpdFxuICAgICAgICAgICAgY29uc3Qgc3RhcnRJZHggPSAodGhpcy5kZXNpZ25DaGlsZEluZGV4VG9BcnJheVBvc2l0aW9uICYmIHRoaXMuZGVzaWduQ2hpbGRJbmRleFRvQXJyYXlQb3NpdGlvbltkZXNpZ25DaGlsZEluZGV4XSAhPT0gdW5kZWZpbmVkKSA/XG4gICAgICAgICAgICAgICAgdGhpcy5kZXNpZ25DaGlsZEluZGV4VG9BcnJheVBvc2l0aW9uW2Rlc2lnbkNoaWxkSW5kZXhdIDogMDtcbiAgICAgICAgICAgIHRoaXMucmVjYWxjdWxhdGVDaGlsZFJ1bnRpbWVJbmRleGVzU3RhcnRpbmdBdChzdGFydElkeCwgZmFsc2UpO1xuICAgICAgICB9IGVsc2UgaWYgKGluaXRpYWxSb290UmVjYWxjdWxhdGUpIHtcbiAgICAgICAgICAgIC8vIHRoaXMgaXMgJHJvb3RTY29wZSAob25lICRwYXJlbnQgZXh0cmEgY2F1c2UgdGhlIGRpcmVjdGl2ZSBjcmVhdGVzIGl0KTsgd2UgYWx3YXlzIGFzc3VtZSBhIHNhYmxvVGFic2VxIGRpcmVjdGl2ZSBpcyBib3VuZCB0byBpdDtcbiAgICAgICAgICAgIC8vIG5vdyB0aGF0IGl0IGlzIGxpbmtlZCB3ZSBjYW4gZG8gaW5pdGlhbCBjYWxjdWxhdGlvbiBvZiB0cmVcbiAgICAgICAgICAgIHRoaXMucnVudGltZUluZGV4LnN0YXJ0SW5kZXggPSB0aGlzLnJ1bnRpbWVJbmRleC5uZXh0QXZhaWxhYmxlSW5kZXggPSAxO1xuICAgICAgICAgICAgdGhpcy5yZWNhbGN1bGF0ZUNoaWxkUnVudGltZUluZGV4ZXNTdGFydGluZ0F0KDAsIHRydWUpO1xuICAgICAgICB9IC8vIGVsc2Ugd2FpdCBmb3IgcGFyZW50IHRhYlNlcSBkaXJlY3RpdmVzIHRvIGdldCBsaW5rZWQgYXMgd2VsbFxuXG4gICAgICAgIGlmKGV2ZW50KSBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ2Rpc2FibGVUYWJzZXEnLCBbJyRldmVudCddKVxuICAgIGRpc2FibGVUYWJzZXEoZXZlbnQ6IEN1c3RvbUV2ZW50PGJvb2xlYW4+KTogYm9vbGVhbiB7XG4gICAgICAgIHRoaXMuaXNFbmFibGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMucmVjYWxjdWxhdGVDaGlsZFJ1bnRpbWVJbmRleGVzU3RhcnRpbmdBdCgwLCB0cnVlKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCdlbmFibGVUYWJzZXEnLCBbJyRldmVudCddKVxuICAgIGVuYWJsZVRhYnNlcShldmVudDogQ3VzdG9tRXZlbnQ8Ym9vbGVhbj4pOiBib29sZWFuIHtcbiAgICAgICAgdGhpcy5pc0VuYWJsZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLnRyaWdnZXIodGhpcy5fZWxlbVJlZi5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUsICdyZWNhbGN1bGF0ZVBTVFMnLCBbMCwgZmFsc2VdKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICAgICAgLy8gY2FsbGVkIGJ5IGFuZ3VsYXIgaW4gcGFyZW50cyBmaXJzdCB0aGVuIGluIGNoaWxkcmVuXG4gICAgICAgIGlmICghdGhpcy5kZXNpZ25UYWJTZXEpIHRoaXMuZGVzaWduVGFiU2VxID0gMDtcblxuICAgICAgICB0aGlzLmluaXRpYWxpemluZyA9IHRydWU7XG4gICAgICAgIHRoaXMuaXNFbmFibGVkID0gdHJ1ZTtcblxuICAgICAgICAvLyBydW50aW1lIGluZGV4IC0xID09IFNLSVAgZm9jdXMgdHJhdmVyc2FsIGluIGJyb3dzZXJcbiAgICAgICAgLy8gcnVudGltZSBpbmRleCAgMCA9PSBERUZBVUxUID09IGRlc2lnbiB0YWIgc2VxIDAgKG5vdCB0YWJJbmRleCBhdHRyIHNldCB0byBlbGVtZW50IG9yIGl0J3MgY2hpbGRyZW4pXG4gICAgICAgIHRoaXMucnVudGltZUluZGV4ID0geyBzdGFydEluZGV4OiAtMSwgbmV4dEF2YWlsYWJsZUluZGV4OiAtMSwgc2FibG90YWJzZXE6IHRoaXMgfTtcbiAgICAgICAgLy8gLTEgcnVudGltZSBpbml0aWFsbHkgZm9yIGFsbCAoaW4gY2FzZSBzb21lIG5vZGUgaW4gdGhlIHRyZWUgaGFzIC0yIGRlc2lnbiAoc2tpcCkgYW5kIGNoaWxkcmVuIGhhdmUgPj0gMCxcbiAgICAgICAgLy8gYXQgcnVudGltZSBhbGwgY2hpbGRyZW4gc2hvdWxkIGJlIGV4Y2x1ZGVkIGFzIHdlbClcbiAgICAgICAgdGhpcy51cGRhdGVDdXJyZW50RG9tRWxUYWJJbmRleCgpO1xuXG4gICAgICAgIC8vIGNoZWNrIHRvIHNlZSBpZiB0aGlzIGlzIHRoZSB0b3AtbW9zdCB0YWJTZXEgY29udGFpbmVyXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZyAmJiB0aGlzLmNvbmZpZy5yb290KSB7XG4gICAgICAgICAgICAvLyBpdCdzIHJvb3QgdGFiIHNlcSBjb250YWluZXIgKHNvIG5vIHBhcmVudCk7IGp1c3QgZG8gaW5pdGlhbCB0cmVlIGNhbGN1bGF0aW9uXG4gICAgICAgICAgICB0aGlzLnJlY2FsY3VsYXRlSW5kZXhlc0hhbmRsZXIoMCwgdHJ1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5kZXNpZ25UYWJTZXEgIT09IC0yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKHRoaXMuX2VsZW1SZWYubmF0aXZlRWxlbWVudC5wYXJlbnROb2RlLCAncmVnaXN0ZXJDU1RTJywgW3RoaXMuZGVzaWduVGFiU2VxLCB0aGlzLnJ1bnRpbWVJbmRleF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgICAgICBjb25zdCBjaGFuZ2UgPSBjaGFuZ2VzWydkZXNpZ25UYWJTZXEnXTtcbiAgICAgICAgaWYgKGNoYW5nZSAmJiAhY2hhbmdlLmZpcnN0Q2hhbmdlKSB7XG4gICAgICAgICAgICBpZiAoISh0aGlzLmNvbmZpZyAmJiB0aGlzLmNvbmZpZy5yb290KSkge1xuICAgICAgICAgICAgICAgIGlmIChjaGFuZ2UucHJldmlvdXNWYWx1ZSAhPT0gLTIpIHRoaXMudHJpZ2dlcih0aGlzLl9lbGVtUmVmLm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZSwgJ3VucmVnaXN0ZXJDU1RTJywgW2NoYW5nZS5wcmV2aW91c1ZhbHVlLCB0aGlzLnJ1bnRpbWVJbmRleF0pO1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5kZXNpZ25UYWJTZXEpIHRoaXMuZGVzaWduVGFiU2VxID0gMDtcbiAgICAgICAgICAgICAgICB0aGlzLnJ1bnRpbWVJbmRleC5zdGFydEluZGV4ID0gLTE7XG4gICAgICAgICAgICAgICAgdGhpcy5ydW50aW1lSW5kZXgubmV4dEF2YWlsYWJsZUluZGV4ID0gLTE7XG4gICAgICAgICAgICAgICAgdGhpcy5pbml0aWFsaXppbmcgPSB0cnVlO1xuXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVzaWduVGFiU2VxICE9PSAtMikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIodGhpcy5fZWxlbVJlZi5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUsICdyZWdpc3RlckNTVFMnLCBbdGhpcy5kZXNpZ25UYWJTZXEsIHRoaXMucnVudGltZUluZGV4XSk7XG4gICAgICAgICAgICAgICAgICAgIC8vIGhlcmUgd2UgY291bGQgc2VuZCBbMF0gaW5zdGVhZCBvZiBbZGVzaWduVGFiU2VxXSAtIGl0IHdvdWxkIHBvdGVudGlhbGx5IGNhbGN1bGF0ZSBtb3JlIGJ1dCBzdGFydCBhZ2FpbiBmcm9tIGZpcnN0IHBhcmVudCBhdmFpbGFibGUgaW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIC8vIG5vdCBoaWdoZXIgaW5kZXggKHRoZSBlbmQgdXNlciBiZWhhdmlvciBiZWluZyB0aGUgc2FtZSlcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKHRoaXMuX2VsZW1SZWYubmF0aXZlRWxlbWVudC5wYXJlbnROb2RlLCAncmVjYWxjdWxhdGVQU1RTJywgW3RoaXMuZGVzaWduVGFiU2VxXSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVDdXJyZW50RG9tRWxUYWJJbmRleCgpOyAvLyAtMSBydW50aW1lXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVjYWxjdWxhdGVDaGlsZFJ1bnRpbWVJbmRleGVzU3RhcnRpbmdBdChwb3NJbkRlc2lnbkFycmF5IC8qaW5jbHVzaXZlKi8sIHRyaWdnZXJlZEJ5UGFyZW50KTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmRlc2lnblRhYlNlcSA9PT0gLTIpIHJldHVybjtcblxuICAgICAgICBpZiAoIXRoaXMuaXNFbmFibGVkIHx8IHRoaXMucnVudGltZUluZGV4LnN0YXJ0SW5kZXggPT09IC0xKSB7XG5cbiAgICAgICAgICAgIHRoaXMucnVudGltZUluZGV4Lm5leHRBdmFpbGFibGVJbmRleCA9IHRoaXMucnVudGltZUluZGV4LnN0YXJ0SW5kZXg7XG4gICAgICAgICAgICB0aGlzLnJ1bnRpbWVJbmRleC5zdGFydEluZGV4ID0gLTE7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5kZXNpZ25UYWJTZXEgPT09IDApIHtcbiAgICAgICAgICAgIC8vIHRoaXMgZWxlbWVudCBkb2Vzbid0IHNldCBhbnkgdGFiSW5kZXggYXR0cmlidXRlIChkZWZhdWx0IGJlaGF2aW9yKVxuICAgICAgICAgICAgdGhpcy5ydW50aW1lSW5kZXgubmV4dEF2YWlsYWJsZUluZGV4ID0gdGhpcy5ydW50aW1lSW5kZXguc3RhcnRJbmRleDtcbiAgICAgICAgICAgIHRoaXMucnVudGltZUluZGV4LnN0YXJ0SW5kZXggPSAwO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMucnVudGltZUluZGV4LnN0YXJ0SW5kZXggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMucnVudGltZUluZGV4Lm5leHRBdmFpbGFibGVJbmRleCA9IDA7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5ydW50aW1lSW5kZXgubmV4dEF2YWlsYWJsZUluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgY29uc3QgcmVzZXJ2ZWRHYXAgPSAodGhpcy5jb25maWcgJiYgdGhpcy5jb25maWcucmVzZXJ2ZWRHYXApID8gdGhpcy5jb25maWcucmVzZXJ2ZWRHYXAgOiAwO1xuICAgICAgICAgICAgdGhpcy5ydW50aW1lSW5kZXgubmV4dEF2YWlsYWJsZUluZGV4ID0gdGhpcy5ydW50aW1lSW5kZXguc3RhcnRJbmRleCArIHJlc2VydmVkR2FwO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBvc0luRGVzaWduQXJyYXkgPT09IDApIHRoaXMudXBkYXRlQ3VycmVudERvbUVsVGFiSW5kZXgoKTtcblxuICAgICAgICBsZXQgcmVjYWxjdWxhdGVTdGFydEluZGV4ID0gdGhpcy5ydW50aW1lSW5kZXguc3RhcnRJbmRleDtcbiAgICAgICAgaWYgKHBvc0luRGVzaWduQXJyYXkgPiAwICYmIHBvc0luRGVzaWduQXJyYXkgLSAxIDwgdGhpcy5kZXNpZ25DaGlsZFRhYlNlcS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IHJ1bnRpbWVDSSA9IHRoaXMucnVudGltZUNoaWxkSW5kZXhlc1t0aGlzLmRlc2lnbkNoaWxkVGFiU2VxW3Bvc0luRGVzaWduQXJyYXkgLSAxXV07IC8vIHRoaXMgY2FuIGJlIGFuIGFycmF5IGluIGNhc2Ugb2YgbXVsdGlwbGUgZXF1YWwgZGVzaWduIGluZGV4ZXMgYmVpbmcgc2libGluZ3NcbiAgICAgICAgICAgIHJlY2FsY3VsYXRlU3RhcnRJbmRleCA9IHJ1bnRpbWVDSS5wdXNoID8gcnVudGltZUNJW3J1bnRpbWVDSS5sZW5ndGggLSAxXS5uZXh0QXZhaWxhYmxlSW5kZXggOiBydW50aW1lQ0kubmV4dEF2YWlsYWJsZUluZGV4O1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IHBvc0luRGVzaWduQXJyYXk7IGkgPCB0aGlzLmRlc2lnbkNoaWxkVGFiU2VxLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBjaGlsZFJ1bnRpbWVJbmRleCA9IHRoaXMucnVudGltZUNoaWxkSW5kZXhlc1t0aGlzLmRlc2lnbkNoaWxkVGFiU2VxW2ldXTtcbiAgICAgICAgICAgIGlmIChjaGlsZFJ1bnRpbWVJbmRleC5wdXNoKSB7XG4gICAgICAgICAgICAgICAgLy8gbXVsdGlwbGUgZXF1YWwgZGVzaWduIHRpbWUgaW5kZXhlcyBhcyBzaWJsaW5nc1xuICAgICAgICAgICAgICAgIGxldCBtYXggPSByZWNhbGN1bGF0ZVN0YXJ0SW5kZXg7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBrIGluIGNoaWxkUnVudGltZUluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKGNoaWxkUnVudGltZUluZGV4Lmhhc093blByb3BlcnR5KGspKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFJ1bnRpbWVJbmRleFtrXS5zdGFydEluZGV4ID0gcmVjYWxjdWxhdGVTdGFydEluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FsbCByZWNhbGN1bGF0ZSBvbiB3aG9sZSBjaGlsZDsgbm9ybWFsbHkgaXQgb25seSBtYWtlcyBzZW5zZSBmb3Igc2FtZSBpbmRleCBzaWJsaW5nc1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhleSBhcmUgbm90IHRoZW1zZWxmZXMgY29udGFpbmVycywganVzdCBhcHBseSB0aGUgZ2l2ZW4gdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkUnVudGltZUluZGV4W2tdLnNhYmxvdGFic2VxLnJlY2FsY3VsYXRlQ2hpbGRSdW50aW1lSW5kZXhlc1N0YXJ0aW5nQXQoMCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF4IDwgY2hpbGRSdW50aW1lSW5kZXhba10ubmV4dEF2YWlsYWJsZUluZGV4KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heCA9IGNoaWxkUnVudGltZUluZGV4W2tdLm5leHRBdmFpbGFibGVJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZWNhbGN1bGF0ZVN0YXJ0SW5kZXggPSBtYXg7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNoaWxkUnVudGltZUluZGV4LnN0YXJ0SW5kZXggPSByZWNhbGN1bGF0ZVN0YXJ0SW5kZXg7XG4gICAgICAgICAgICAgICAgY2hpbGRSdW50aW1lSW5kZXguc2FibG90YWJzZXEucmVjYWxjdWxhdGVDaGlsZFJ1bnRpbWVJbmRleGVzU3RhcnRpbmdBdCgwLCB0cnVlKTsgLy8gY2FsbCByZWNhbGN1bGF0ZSBvbiB3aG9sZSBjaGlsZFxuICAgICAgICAgICAgICAgIHJlY2FsY3VsYXRlU3RhcnRJbmRleCA9IGNoaWxkUnVudGltZUluZGV4Lm5leHRBdmFpbGFibGVJbmRleDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluaXRpYWxpemluZykgdGhpcy5pbml0aWFsaXppbmcgPSB1bmRlZmluZWQ7IC8vIGl0J3Mgbm93IGNvbnNpZGVyZWQgaW5pdGlhbGl6ZWQgYXMgZmlyc3QgcnVudGltZSBpbmRleCBjYWx1Y3VsYXRpb24gaXMgZG9uZVxuXG4gICAgICAgIGxldCBwYXJlbnRSZWNhbGN1bGF0ZU5lZWRlZDtcbiAgICAgICAgaWYgKHRoaXMucnVudGltZUluZGV4LnN0YXJ0SW5kZXggIT09IDAgJiYgdGhpcy5ydW50aW1lSW5kZXguc3RhcnRJbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIGNvbnN0IG93blRhYkluZGV4QnVtcCA9IHRoaXMuaGFzT3duVGFiSW5kZXgoKSA/IDEgOiAwO1xuICAgICAgICAgICAgcGFyZW50UmVjYWxjdWxhdGVOZWVkZWQgPSAodGhpcy5ydW50aW1lSW5kZXgubmV4dEF2YWlsYWJsZUluZGV4IDwgcmVjYWxjdWxhdGVTdGFydEluZGV4ICsgb3duVGFiSW5kZXhCdW1wKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc2VydmVkR2FwID0gKHRoaXMuY29uZmlnICYmIHRoaXMuY29uZmlnLnJlc2VydmVkR2FwKSA/IHRoaXMuY29uZmlnLnJlc2VydmVkR2FwIDogMDtcbiAgICAgICAgICAgIGlmIChwYXJlbnRSZWNhbGN1bGF0ZU5lZWRlZCkgdGhpcy5ydW50aW1lSW5kZXgubmV4dEF2YWlsYWJsZUluZGV4ID0gcmVjYWxjdWxhdGVTdGFydEluZGV4ICsgcmVzZXJ2ZWRHYXAgKyBvd25UYWJJbmRleEJ1bXA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBzdGFydCBpbmRleCAwIG1lYW5zIGRlZmF1bHQgKG5vIHRhYkluZGV4IGF0dHIuIHNldClcbiAgICAgICAgICAgIHBhcmVudFJlY2FsY3VsYXRlTmVlZGVkID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBpZiB0aGlzIGNvbnRhaW5lciBub3cgbmVlZHMgbW9yZSB0YWIgaW5kZXhlcyB0aGFuIGl0IHdhcyByZXNlcnZlZDsgYSByZWNhbGN1bGF0ZSBvbiBwYXJlbnQgbmVlZHMgdG8gYmUgdHJpZ2dlcmVkIGluIHRoaXMgY2FzZVxuICAgICAgICBpZiAocGFyZW50UmVjYWxjdWxhdGVOZWVkZWQgJiYgIXRyaWdnZXJlZEJ5UGFyZW50KSB0aGlzLnRyaWdnZXIodGhpcy5fZWxlbVJlZi5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUsICdyZWNhbGN1bGF0ZVBTVFMnLCBbdGhpcy5kZXNpZ25UYWJTZXEsIGZhbHNlXSk7XG4gICAgfVxuXG4gICAgaGFzT3duVGFiSW5kZXgoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoIXRoaXMuY29uZmlnIHx8ICEodGhpcy5jb25maWcuY29udGFpbmVyIHx8IHRoaXMuY29uZmlnLnJvb3QpKTtcbiAgICB9XG5cbiAgICB1cGRhdGVDdXJyZW50RG9tRWxUYWJJbmRleCgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuaGFzT3duVGFiSW5kZXgoKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMucnVudGltZUluZGV4LnN0YXJ0SW5kZXggIT09IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldERPTVRhYkluZGV4KHRoaXMucnVudGltZUluZGV4LnN0YXJ0SW5kZXgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldERPTVRhYkluZGV4KHVuZGVmaW5lZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZXRET01UYWJJbmRleCh0YWJpbmRleCk6IHZvaWQge1xuICAgICAgICB0aGlzLnRhYmluZGV4ID0gdGFiaW5kZXg7XG4gICAgICAgIHRoaXMuY2RSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cblxuICAgIHRyaWdnZXIodGFyZ2V0LCBldmVudDogc3RyaW5nLCBhcmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY3VzdG9tRXZlbnQgPSBuZXcgQ3VzdG9tRXZlbnQoZXZlbnQsIHtcbiAgICAgICAgICAgIGJ1YmJsZXM6IHRydWUsXG4gICAgICAgICAgICBkZXRhaWw6IGFyZ1xuICAgICAgICAgIH0pO1xuICAgICAgICB0YXJnZXQuZGlzcGF0Y2hFdmVudChjdXN0b21FdmVudCk7XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgICAgIC8vIHVucmVnaXN0ZXIgY3VycmVudCB0YWJTZXEgZnJvbSBwYXJlbnQgdGFiU2VxIGNvbnRhaW5lclxuICAgICAgICBpZih0aGlzLl9lbGVtUmVmLm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZSkge1xuICAgICAgICAgICAgdGhpcy50cmlnZ2VyKHRoaXMuX2VsZW1SZWYubmF0aXZlRWxlbWVudC5wYXJlbnROb2RlLCAndW5yZWdpc3RlckNTVFMnLCBbdGhpcy5kZXNpZ25UYWJTZXEsIHRoaXMucnVudGltZUluZGV4XSk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=
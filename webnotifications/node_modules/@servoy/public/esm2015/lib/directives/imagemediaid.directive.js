import { Directive, Input } from '@angular/core';
import * as i0 from "@angular/core";
export class ImageMediaIdDirective {
    constructor(_elemRef, _renderer) {
        this._elemRef = _elemRef;
        this._renderer = _renderer;
        this.clearStyle = new Map();
        this.clearStyle.set('width', '0px');
        this.clearStyle.set('height', '0px');
        this.clearStyle.set('backgroundImage', '');
    }
    ngOnChanges(changes) {
        if (changes['hostComponent']) {
            this.hostComponent.addViewStateListener(this);
        }
    }
    ngOnDestroy() {
        if (this.hostComponent) {
            this.hostComponent.removeViewStateListener(this);
        }
    }
    afterViewInit() {
        const nativeElement = this.hostComponent.getNativeElement();
        const renderer = this.hostComponent.getRenderer();
        renderer.listen(nativeElement, 'mouseenter', (e) => {
            if (this.rollOverImgStyle) {
                this.setCSSStyle(this.rollOverImgStyle);
            }
        });
        renderer.listen(nativeElement, 'mouseleave', (e) => {
            if (this.rollOverImgStyle) {
                if (this.imgStyle) {
                    this.setCSSStyle(this.imgStyle);
                }
                else {
                    this.setCSSStyle(this.clearStyle);
                }
            }
        });
        this.setImageStyle();
    }
    setImageStyle() {
        if (this.media && (this.media.img || this.media.rollOverImg) || this.rollOverImgStyle || this.imgStyle) {
            const componentSize = {
                width: this._elemRef.nativeElement.parentNode.parentNode.clientWidth,
                height: this._elemRef.nativeElement.parentNode.parentNode.clientHeight
            };
            if (componentSize.height === 0 || componentSize.width === 0)
                setTimeout(() => this.setImageStyle(), 100);
            else {
                const mediaOptions = this.media.mediaOptions;
                if (this.media.rollOverImg) {
                    this.rollOverImgStyle = this.parseImageOptions(this.media.rollOverImg, mediaOptions, componentSize);
                }
                else {
                    this.rollOverImgStyle = null;
                }
                if (this.media.img) {
                    this.imgStyle = this.parseImageOptions(this.media.img, mediaOptions, componentSize);
                    this.setCSSStyle(this.imgStyle);
                }
                else {
                    this.imgStyle = null;
                    this.setCSSStyle(this.clearStyle);
                }
            }
        }
    }
    parseImageOptions(image, mediaOptions, componentSize) {
        const bgstyle = new Map();
        bgstyle.set('background-image', 'url(\'' + image + '\')');
        bgstyle.set('background-repeat', 'no-repeat');
        bgstyle.set('background-position', 'left');
        bgstyle.set('display', 'inline-block');
        bgstyle.set('vertical-align', 'middle');
        if (mediaOptions === undefined)
            mediaOptions = 14; // reduce-enlarge & keep aspect ration
        const mediaKeepAspectRatio = mediaOptions === 0 || ((mediaOptions & 8) === 8);
        // default  img size values
        let imgWidth = 16;
        let imgHeight = 16;
        if (image.indexOf('imageWidth=') > 0 && image.indexOf('imageHeight=') > 0) {
            const vars = {};
            image.replace(/[?&]+([^=&]+)=([^&]*)/gi, (m, key, value) => {
                vars[key] = value;
            });
            imgWidth = vars['imageWidth'];
            imgHeight = vars['imageHeight'];
        }
        const widthChange = imgWidth / componentSize.width;
        const heightChange = imgHeight / componentSize.height;
        if (widthChange > 1.01 || heightChange > 1.01 || widthChange < 0.99 || heightChange < 0.99) {
            if ((mediaOptions & 6) === 6) {
                if (mediaKeepAspectRatio) {
                    if (widthChange > heightChange) {
                        imgWidth = imgWidth / widthChange;
                        imgHeight = imgHeight / widthChange;
                    }
                    else {
                        imgWidth = imgWidth / heightChange;
                        imgHeight = imgHeight / heightChange;
                    }
                }
                else {
                    imgWidth = componentSize.width;
                    imgHeight = componentSize.height;
                }
            }
            else if ((mediaOptions & 2) == 2) {
                if (widthChange > 1.01 && heightChange > 1.01) {
                    if (mediaKeepAspectRatio) {
                        if (widthChange > heightChange) {
                            imgWidth = imgWidth / widthChange;
                            imgHeight = imgHeight / widthChange;
                        }
                        else {
                            imgWidth = imgWidth / heightChange;
                            imgHeight = imgHeight / heightChange;
                        }
                    }
                    else {
                        imgWidth = componentSize.width;
                        imgHeight = componentSize.height;
                    }
                }
                else if (widthChange > 1.01) {
                    imgWidth = imgWidth / widthChange;
                    if (mediaKeepAspectRatio) {
                        imgHeight = imgHeight / widthChange;
                    }
                    else {
                        imgHeight = componentSize.height;
                    }
                }
                else if (heightChange > 1.01) {
                    imgHeight = imgHeight / heightChange;
                    if (mediaKeepAspectRatio) {
                        imgWidth = imgWidth / heightChange;
                    }
                    else {
                        imgWidth = componentSize.width;
                    }
                }
            }
            else if ((mediaOptions & 4) == 4) {
                if (widthChange < 0.99 && heightChange < 0.99) {
                    if (mediaKeepAspectRatio) {
                        if (widthChange > heightChange) {
                            imgWidth = imgWidth / widthChange;
                            imgHeight = imgHeight / widthChange;
                        }
                        else {
                            imgWidth = imgWidth / heightChange;
                            imgHeight = imgHeight / heightChange;
                        }
                    }
                    else {
                        imgWidth = componentSize.width;
                        imgHeight = componentSize.height;
                    }
                }
                else if (widthChange < 0.99) {
                    imgWidth = imgWidth / widthChange;
                    if (mediaKeepAspectRatio) {
                        imgHeight = imgHeight / widthChange;
                    }
                    else {
                        imgHeight = componentSize.height;
                    }
                }
                else if (heightChange < 0.99) {
                    imgHeight = imgHeight / heightChange;
                    if (mediaKeepAspectRatio) {
                        imgWidth = imgWidth / heightChange;
                    }
                    else {
                        imgWidth = componentSize.width;
                    }
                }
            }
        }
        bgstyle.set('background-size', mediaKeepAspectRatio ? 'contain' : '100% 100%');
        bgstyle.set('width', Math.round(imgWidth) + 'px');
        bgstyle.set('height', Math.round(imgHeight) + 'px');
        return bgstyle;
    }
    setCSSStyle(cssStyle) {
        cssStyle.forEach((value, key) => {
            this._renderer.setStyle(this._elemRef.nativeElement, key, value);
        });
    }
}
ImageMediaIdDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: ImageMediaIdDirective, deps: [{ token: i0.ElementRef }, { token: i0.Renderer2 }], target: i0.ɵɵFactoryTarget.Directive });
ImageMediaIdDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.0.2", type: ImageMediaIdDirective, selector: "[svyImageMediaId]", inputs: { media: ["svyImageMediaId", "media"], hostComponent: "hostComponent" }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.2", ngImport: i0, type: ImageMediaIdDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[svyImageMediaId]'
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.Renderer2 }]; }, propDecorators: { media: [{
                type: Input,
                args: ['svyImageMediaId']
            }], hostComponent: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2VtZWRpYWlkLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NlcnZveS1wdWJsaWMvc3JjL2xpYi9kaXJlY3RpdmVzL2ltYWdlbWVkaWFpZC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQThELE1BQU0sZUFBZSxDQUFDOztBQU83RyxNQUFNLE9BQU8scUJBQXFCO0lBUzlCLFlBQTJCLFFBQWlDLEVBQVUsU0FBb0I7UUFBL0QsYUFBUSxHQUFSLFFBQVEsQ0FBeUI7UUFBVSxjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQ3RGLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxXQUFXLENBQUMsT0FBc0I7UUFDOUIsSUFBSSxPQUFPLENBQUMsZUFBZSxDQUFDLEVBQUU7WUFDMUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqRDtJQUNMLENBQUM7SUFFRCxXQUFXO1FBQ1AsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3BCLElBQUksQ0FBQyxhQUFhLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDcEQ7SUFDTCxDQUFDO0lBRUQsYUFBYTtRQUNULE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUM1RCxNQUFNLFFB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ZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSW5wdXQsIFNpbXBsZUNoYW5nZXMsIE9uQ2hhbmdlcywgRWxlbWVudFJlZiwgUmVuZGVyZXIyLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFNlcnZveUJhc2VDb21wb25lbnQgfSBmcm9tICcuLi9iYXNlY29tcG9uZW50JztcbmltcG9ydCB7IElWaWV3U3RhdGVMaXN0ZW5lciB9IGZyb20gJy4uL2Jhc2Vjb21wb25lbnQnO1xuXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1tzdnlJbWFnZU1lZGlhSWRdJ1xufSlcbmV4cG9ydCBjbGFzcyBJbWFnZU1lZGlhSWREaXJlY3RpdmUgaW1wbGVtZW50cyBPbkNoYW5nZXMsIElWaWV3U3RhdGVMaXN0ZW5lciwgT25EZXN0cm95IHtcblxuICAgIEBJbnB1dCgnc3Z5SW1hZ2VNZWRpYUlkJykgbWVkaWE6IGFueTtcbiAgICBASW5wdXQoKSBob3N0Q29tcG9uZW50OiBTZXJ2b3lCYXNlQ29tcG9uZW50PEhUTUxFbGVtZW50PjtcblxuICAgIHByaXZhdGUgaW1nU3R5bGU6IE1hcDxzdHJpbmcsIGFueT47XG4gICAgcHJpdmF0ZSByb2xsT3ZlckltZ1N0eWxlOiBNYXA8c3RyaW5nLCBhbnk+O1xuICAgIHByaXZhdGUgY2xlYXJTdHlsZTogTWFwPHN0cmluZywgYW55PjtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIF9lbGVtUmVmOiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PiwgcHJpdmF0ZSBfcmVuZGVyZXI6IFJlbmRlcmVyMikge1xuICAgICAgICB0aGlzLmNsZWFyU3R5bGUgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMuY2xlYXJTdHlsZS5zZXQoJ3dpZHRoJywgJzBweCcpO1xuICAgICAgICB0aGlzLmNsZWFyU3R5bGUuc2V0KCdoZWlnaHQnLCAnMHB4Jyk7XG4gICAgICAgIHRoaXMuY2xlYXJTdHlsZS5zZXQoJ2JhY2tncm91bmRJbWFnZScsICcnKTtcbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgICAgIGlmIChjaGFuZ2VzWydob3N0Q29tcG9uZW50J10pIHtcbiAgICAgICAgICAgIHRoaXMuaG9zdENvbXBvbmVudC5hZGRWaWV3U3RhdGVMaXN0ZW5lcih0aGlzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5ob3N0Q29tcG9uZW50KSB7XG4gICAgICAgICAgICB0aGlzLmhvc3RDb21wb25lbnQucmVtb3ZlVmlld1N0YXRlTGlzdGVuZXIodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZnRlclZpZXdJbml0KCkge1xuICAgICAgICBjb25zdCBuYXRpdmVFbGVtZW50ID0gdGhpcy5ob3N0Q29tcG9uZW50LmdldE5hdGl2ZUVsZW1lbnQoKTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSB0aGlzLmhvc3RDb21wb25lbnQuZ2V0UmVuZGVyZXIoKTtcbiAgICAgICAgcmVuZGVyZXIubGlzdGVuKG5hdGl2ZUVsZW1lbnQsICdtb3VzZWVudGVyJywgKGUpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLnJvbGxPdmVySW1nU3R5bGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldENTU1N0eWxlKHRoaXMucm9sbE92ZXJJbWdTdHlsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJlbmRlcmVyLmxpc3RlbihuYXRpdmVFbGVtZW50LCAnbW91c2VsZWF2ZScsIChlKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5yb2xsT3ZlckltZ1N0eWxlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW1nU3R5bGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDU1NTdHlsZSh0aGlzLmltZ1N0eWxlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldENTU1N0eWxlKHRoaXMuY2xlYXJTdHlsZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zZXRJbWFnZVN0eWxlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRJbWFnZVN0eWxlKCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5tZWRpYSAmJiAodGhpcy5tZWRpYS5pbWcgfHwgdGhpcy5tZWRpYS5yb2xsT3ZlckltZykgfHwgdGhpcy5yb2xsT3ZlckltZ1N0eWxlIHx8IHRoaXMuaW1nU3R5bGUpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbXBvbmVudFNpemUgPSB7XHJcbiAgICAgICAgICAgICAgICB3aWR0aDogKHRoaXMuX2VsZW1SZWYubmF0aXZlRWxlbWVudC5wYXJlbnROb2RlLnBhcmVudE5vZGUgYXMgSFRNTEVsZW1lbnQpLmNsaWVudFdpZHRoLFxuICAgICAgICAgICAgICAgIGhlaWdodDogKHRoaXMuX2VsZW1SZWYubmF0aXZlRWxlbWVudC5wYXJlbnROb2RlLnBhcmVudE5vZGUgYXMgSFRNTEVsZW1lbnQpLmNsaWVudEhlaWdodFxyXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgaWYgKGNvbXBvbmVudFNpemUuaGVpZ2h0ID09PSAwIHx8IGNvbXBvbmVudFNpemUud2lkdGggPT09IDApXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnNldEltYWdlU3R5bGUoKSwgMTAwKTtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1lZGlhT3B0aW9ucyA9IHRoaXMubWVkaWEubWVkaWFPcHRpb25zO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lZGlhLnJvbGxPdmVySW1nKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucm9sbE92ZXJJbWdTdHlsZSA9IHRoaXMucGFyc2VJbWFnZU9wdGlvbnModGhpcy5tZWRpYS5yb2xsT3ZlckltZywgbWVkaWFPcHRpb25zLCBjb21wb25lbnRTaXplKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJvbGxPdmVySW1nU3R5bGUgPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5tZWRpYS5pbWcpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbWdTdHlsZSA9IHRoaXMucGFyc2VJbWFnZU9wdGlvbnModGhpcy5tZWRpYS5pbWcsIG1lZGlhT3B0aW9ucywgY29tcG9uZW50U2l6ZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0Q1NTU3R5bGUodGhpcy5pbWdTdHlsZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbWdTdHlsZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0Q1NTU3R5bGUodGhpcy5jbGVhclN0eWxlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlSW1hZ2VPcHRpb25zKGltYWdlLCBtZWRpYU9wdGlvbnM6IG51bWJlciwgY29tcG9uZW50U2l6ZSk6IE1hcDxzdHJpbmcsIGFueT4ge1xuICAgICAgICBjb25zdCBiZ3N0eWxlID0gbmV3IE1hcCgpO1xuICAgICAgICBiZ3N0eWxlLnNldCgnYmFja2dyb3VuZC1pbWFnZScsICd1cmwoXFwnJyArIGltYWdlICsgJ1xcJyknKTtcbiAgICAgICAgYmdzdHlsZS5zZXQoJ2JhY2tncm91bmQtcmVwZWF0JywgJ25vLXJlcGVhdCcpO1xuICAgICAgICBiZ3N0eWxlLnNldCgnYmFja2dyb3VuZC1wb3NpdGlvbicsICdsZWZ0Jyk7XG4gICAgICAgIGJnc3R5bGUuc2V0KCdkaXNwbGF5JywgJ2lubGluZS1ibG9jaycpO1xuICAgICAgICBiZ3N0eWxlLnNldCgndmVydGljYWwtYWxpZ24nLCAnbWlkZGxlJyk7XG4gICAgICAgIGlmIChtZWRpYU9wdGlvbnMgPT09IHVuZGVmaW5lZCkgbWVkaWFPcHRpb25zID0gMTQ7IC8vIHJlZHVjZS1lbmxhcmdlICYga2VlcCBhc3BlY3QgcmF0aW9uXG4gICAgICAgIGNvbnN0IG1lZGlhS2VlcEFzcGVjdFJhdGlvID0gbWVkaWFPcHRpb25zID09PSAwIHx8ICgobWVkaWFPcHRpb25zICYgOCkgPT09IDgpO1xuXG4gICAgICAgIC8vIGRlZmF1bHQgIGltZyBzaXplIHZhbHVlc1xuICAgICAgICBsZXQgaW1nV2lkdGggPSAxNjtcbiAgICAgICAgbGV0IGltZ0hlaWdodCA9IDE2O1xuXG4gICAgICAgIGlmIChpbWFnZS5pbmRleE9mKCdpbWFnZVdpZHRoPScpID4gMCAmJiBpbWFnZS5pbmRleE9mKCdpbWFnZUhlaWdodD0nKSA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHZhcnMgPSB7fTtcbiAgICAgICAgICAgIGltYWdlLnJlcGxhY2UoL1s/Jl0rKFtePSZdKyk9KFteJl0qKS9naSxcbiAgICAgICAgICAgICAgICAobSwga2V5LCB2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB2YXJzW2tleV0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGltZ1dpZHRoID0gdmFyc1snaW1hZ2VXaWR0aCddO1xuICAgICAgICAgICAgaW1nSGVpZ2h0ID0gdmFyc1snaW1hZ2VIZWlnaHQnXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHdpZHRoQ2hhbmdlID0gaW1nV2lkdGggLyBjb21wb25lbnRTaXplLndpZHRoO1xuICAgICAgICBjb25zdCBoZWlnaHRDaGFuZ2UgPSBpbWdIZWlnaHQgLyBjb21wb25lbnRTaXplLmhlaWdodDtcblxuICAgICAgICBpZiAod2lkdGhDaGFuZ2UgPiAxLjAxIHx8IGhlaWdodENoYW5nZSA+IDEuMDEgfHwgd2lkdGhDaGFuZ2UgPCAwLjk5IHx8IGhlaWdodENoYW5nZSA8IDAuOTkpIHtcbiAgICAgICAgICAgIGlmICgobWVkaWFPcHRpb25zICYgNikgPT09IDYpIHtcbiAgICAgICAgICAgICAgICBpZiAobWVkaWFLZWVwQXNwZWN0UmF0aW8pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdpZHRoQ2hhbmdlID4gaGVpZ2h0Q2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbWdXaWR0aCA9IGltZ1dpZHRoIC8gd2lkdGhDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbWdIZWlnaHQgPSBpbWdIZWlnaHQgLyB3aWR0aENoYW5nZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltZ1dpZHRoID0gaW1nV2lkdGggLyBoZWlnaHRDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbWdIZWlnaHQgPSBpbWdIZWlnaHQgLyBoZWlnaHRDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpbWdXaWR0aCA9IGNvbXBvbmVudFNpemUud2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIGltZ0hlaWdodCA9IGNvbXBvbmVudFNpemUuaGVpZ2h0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoKG1lZGlhT3B0aW9ucyAmIDIpID09IDIpIHtcbiAgICAgICAgICAgICAgICBpZiAod2lkdGhDaGFuZ2UgPiAxLjAxICYmIGhlaWdodENoYW5nZSA+IDEuMDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhS2VlcEFzcGVjdFJhdGlvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAod2lkdGhDaGFuZ2UgPiBoZWlnaHRDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWdXaWR0aCA9IGltZ1dpZHRoIC8gd2lkdGhDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1nSGVpZ2h0ID0gaW1nSGVpZ2h0IC8gd2lkdGhDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltZ1dpZHRoID0gaW1nV2lkdGggLyBoZWlnaHRDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1nSGVpZ2h0ID0gaW1nSGVpZ2h0IC8gaGVpZ2h0Q2hhbmdlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1nV2lkdGggPSBjb21wb25lbnRTaXplLndpZHRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1nSGVpZ2h0ID0gY29tcG9uZW50U2l6ZS5oZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHdpZHRoQ2hhbmdlID4gMS4wMSkge1xuICAgICAgICAgICAgICAgICAgICBpbWdXaWR0aCA9IGltZ1dpZHRoIC8gd2lkdGhDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYUtlZXBBc3BlY3RSYXRpbykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1nSGVpZ2h0ID0gaW1nSGVpZ2h0IC8gd2lkdGhDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbWdIZWlnaHQgPSBjb21wb25lbnRTaXplLmhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVpZ2h0Q2hhbmdlID4gMS4wMSkge1xuICAgICAgICAgICAgICAgICAgICBpbWdIZWlnaHQgPSBpbWdIZWlnaHQgLyBoZWlnaHRDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYUtlZXBBc3BlY3RSYXRpbykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1nV2lkdGggPSBpbWdXaWR0aCAvIGhlaWdodENoYW5nZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltZ1dpZHRoID0gY29tcG9uZW50U2l6ZS53aWR0aDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoKG1lZGlhT3B0aW9ucyAmIDQpID09IDQpIHtcbiAgICAgICAgICAgICAgICBpZiAod2lkdGhDaGFuZ2UgPCAwLjk5ICYmIGhlaWdodENoYW5nZSA8IDAuOTkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhS2VlcEFzcGVjdFJhdGlvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAod2lkdGhDaGFuZ2UgPiBoZWlnaHRDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWdXaWR0aCA9IGltZ1dpZHRoIC8gd2lkdGhDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1nSGVpZ2h0ID0gaW1nSGVpZ2h0IC8gd2lkdGhDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltZ1dpZHRoID0gaW1nV2lkdGggLyBoZWlnaHRDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1nSGVpZ2h0ID0gaW1nSGVpZ2h0IC8gaGVpZ2h0Q2hhbmdlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1nV2lkdGggPSBjb21wb25lbnRTaXplLndpZHRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1nSGVpZ2h0ID0gY29tcG9uZW50U2l6ZS5oZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHdpZHRoQ2hhbmdlIDwgMC45OSkge1xuICAgICAgICAgICAgICAgICAgICBpbWdXaWR0aCA9IGltZ1dpZHRoIC8gd2lkdGhDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYUtlZXBBc3BlY3RSYXRpbykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1nSGVpZ2h0ID0gaW1nSGVpZ2h0IC8gd2lkdGhDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbWdIZWlnaHQgPSBjb21wb25lbnRTaXplLmhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVpZ2h0Q2hhbmdlIDwgMC45OSkge1xuICAgICAgICAgICAgICAgICAgICBpbWdIZWlnaHQgPSBpbWdIZWlnaHQgLyBoZWlnaHRDaGFuZ2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYUtlZXBBc3BlY3RSYXRpbykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1nV2lkdGggPSBpbWdXaWR0aCAvIGhlaWdodENoYW5nZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltZ1dpZHRoID0gY29tcG9uZW50U2l6ZS53aWR0aDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGJnc3R5bGUuc2V0KCdiYWNrZ3JvdW5kLXNpemUnLCBtZWRpYUtlZXBBc3BlY3RSYXRpbyA/ICdjb250YWluJyA6ICcxMDAlIDEwMCUnKTtcbiAgICAgICAgYmdzdHlsZS5zZXQoJ3dpZHRoJywgTWF0aC5yb3VuZChpbWdXaWR0aCkgKyAncHgnKTtcbiAgICAgICAgYmdzdHlsZS5zZXQoJ2hlaWdodCcsIE1hdGgucm91bmQoaW1nSGVpZ2h0KSArICdweCcpO1xuXG4gICAgICAgIHJldHVybiBiZ3N0eWxlO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0Q1NTU3R5bGUoY3NzU3R5bGU6IE1hcDxzdHJpbmcsIGFueT4pIHtcbiAgICAgICAgY3NzU3R5bGUuZm9yRWFjaCgodmFsdWU6IGFueSwga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFN0eWxlKHRoaXMuX2VsZW1SZWYubmF0aXZlRWxlbWVudCwga2V5LCB2YWx1ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==